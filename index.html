<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <title>Voice Translator</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="theme-color" content="#00E676">
  <link rel="manifest" href="manifest.json">

  <style>
    body{
      margin:0;font-family:"Segoe UI",Tahoma,sans-serif;
      background:linear-gradient(135deg,#0f2027,#203a43,#2c5364);
      color:#fff;min-height:100vh;display:flex;justify-content:center;align-items:center;
      padding:18px;box-sizing:border-box
    }
    .card{background:#121212;border-radius:20px;padding:22px;width:100%;max-width:520px;
      box-shadow:0 20px 40px rgba(0,0,0,.5);text-align:center}
    h1{margin:0 0 6px 0;color:#00E676;font-size:26px}
    .pill{display:inline-block;padding:6px 10px;border-radius:999px;background:rgba(0,230,118,.12);
      border:1px solid rgba(0,230,118,.35);color:#b9ffd8;font-size:12px;margin:8px 0 12px 0}
    select,button,textarea{width:100%;padding:12px;margin-top:10px;border-radius:12px;border:none;font-size:16px;box-sizing:border-box}
    select,textarea{background:#1e1e1e;color:#fff}
    textarea{resize:vertical;min-height:86px;direction:rtl}
    .row{display:grid;grid-template-columns:1fr 1fr;gap:10px;margin-top:10px}
    button{background:#00E676;color:#000;font-weight:700;cursor:pointer;transition:transform .15s ease}
    button.secondary{background:#2a2a2a;color:#fff;border:1px solid rgba(255,255,255,.12)}
    button:disabled{opacity:.55;cursor:not-allowed}
    button:active{transform:scale(.97)}
    .box{background:#1e1e1e;border-radius:12px;padding:12px;margin-top:12px;min-height:60px;direction:rtl;text-align:center;word-break:break-word}
    .hint{margin-top:10px;font-size:12px;opacity:.9;line-height:1.7;text-align:center}
    .iosBox{
      margin-top:10px;padding:10px;border-radius:12px;
      background:rgba(255,255,255,.06);
      border:1px solid rgba(255,255,255,.10);
      display:none;text-align:right
    }
    .iosBox b{color:#00E676}
    footer{margin-top:14px;font-size:12px;opacity:.7}
  </style>
</head>
<body>

<div class="card">
  <h1>ğŸ¤ Ù…ØªØ±Ø¬Ù… ØµÙˆØªÛŒ</h1>
  <div class="pill" id="platformPill">Ø¯Ø±Ø­Ø§Ù„ Ø¨Ø±Ø±Ø³ÛŒ Ø¯Ø³ØªÚ¯Ø§Ù‡â€¦</div>

  <select id="sourceLang" aria-label="Ø²Ø¨Ø§Ù† ÙˆØ±ÙˆØ¯ÛŒ"></select>
  <select id="targetLang" aria-label="Ø²Ø¨Ø§Ù† Ù…Ù‚ØµØ¯"></select>

  <div class="iosBox" id="iosHelp">
    <div>
      <b>Ø±Ø§Ù‡Ù†Ù…Ø§ÛŒ iPhone (ÙØ§Ø±Ø³ÛŒ):</b><br>
      ØªØ´Ø®ÛŒØµ Ú¯ÙØªØ§Ø± ÙØ§Ø±Ø³ÛŒ Ø¯Ø± Ù…Ø±ÙˆØ±Ú¯Ø± iPhone Ù…Ù…Ú©Ù† Ø§Ø³Øª Ú©Ø§Ø± Ù†Ú©Ù†Ø¯.<br>
      âœ… Ø±ÙˆÛŒ Ú©Ø§Ø¯Ø± Ù…ØªÙ† Ø¨Ø²Ù† â†’ Ú©ÛŒØ¨ÙˆØ±Ø¯ Ø¨Ø§Ø² Ù…ÛŒâ€ŒØ´ÙˆØ¯ â†’ Ø¯Ú©Ù…Ù‡ <b>ğŸ™ï¸ Ù…ÛŒÚ©Ø±ÙˆÙÙˆÙ† (Dictation)</b> Ø±Ø§ Ø¨Ø²Ù† â†’ ÙØ§Ø±Ø³ÛŒ ØµØ­Ø¨Øª Ú©Ù† â†’ Ø¨Ø¹Ø¯ Â«ØªØ±Ø¬Ù…Ù‡ Ù…ØªÙ†Â».<br>
      ğŸ”Š Ø¨Ø±Ø§ÛŒ Ø´Ù†ÛŒØ¯Ù† ØµØ¯Ø§ Ø­ØªÙ…Ø§Ù‹ Â«Ù¾Ø®Ø´ ØªØ±Ø¬Ù…Ù‡Â» Ø±Ø§ Ø¨Ø²Ù†.
    </div>
  </div>

  <textarea id="manualInput" placeholder="Ø§ÛŒÙ†Ø¬Ø§ Ø¨Ù†ÙˆÛŒØ³â€¦ (Ø¯Ø± iPhone Ù…ÛŒâ€ŒØªÙˆØ§Ù†ÛŒ Ø¨Ø§ Dictation Ù…ØªÙ† Ø±Ø§ Ø¨Ú¯ÙˆÛŒÛŒ)"></textarea>

  <div class="row">
    <button id="recordBtn">ğŸ™ Ø´Ø±ÙˆØ¹ ØµØ­Ø¨Øª</button>
    <button id="translateBtn" class="secondary">ğŸ” ØªØ±Ø¬Ù…Ù‡ Ù…ØªÙ†</button>
  </div>

  <div class="row">
    <button id="playBtn" class="secondary" disabled>ğŸ”Š Ù¾Ø®Ø´ ØªØ±Ø¬Ù…Ù‡</button>
    <button id="stopBtn" class="secondary" disabled>â¹ ØªÙˆÙ‚Ù ØµØ¯Ø§</button>
  </div>

  <div class="box" id="originalText">Ù…ØªÙ† ÙˆØ±ÙˆØ¯ÛŒâ€¦</div>
  <div class="box" id="translatedText">ØªØ±Ø¬Ù…Ù‡â€¦</div>

  <div class="hint" id="hintText"></div>
  <footer>Voice Translator PWA</footer>
</div>

<script>
  // --- Detect iOS ---
  const isIOS = (() => {
    const ua = navigator.userAgent || "";
    const iOS = /iPad|iPhone|iPod/.test(ua);
    const iPadOS = (ua.includes("Mac") && "ontouchend" in document);
    return iOS || iPadOS;
  })();

  const elSource = document.getElementById("sourceLang");
  const elTarget = document.getElementById("targetLang");
  const elRecordBtn = document.getElementById("recordBtn");
  const elTranslateBtn = document.getElementById("translateBtn");
  const elPlayBtn = document.getElementById("playBtn");
  const elStopBtn = document.getElementById("stopBtn");
  const elOriginal = document.getElementById("originalText");
  const elTranslated = document.getElementById("translatedText");
  const elManual = document.getElementById("manualInput");
  const elHint = document.getElementById("hintText");
  const elPill = document.getElementById("platformPill");
  const elIOSHelp = document.getElementById("iosHelp");

  elPill.textContent = isIOS ? "ğŸ iPhone/iOS" : "ğŸ¤– Android/Desktop";
  if (isIOS) elIOSHelp.style.display = "block";

  let recognition = null;
  let lastTranslated = "";
  let audioUnlocked = false;

  function showHint(msg){ elHint.textContent = msg || ""; }
  function setAudioButtons(hasText){
    elPlayBtn.disabled = !hasText;
    elStopBtn.disabled = !hasText;
  }

  // -------- Big language list (translate + speech) --------
  // translateCode: for Google translate tl=
  // speechCode: for SpeechRecognition lang=
  const LANGS = [
    {name:"ÙØ§Ø±Ø³ÛŒ", translate:"fa", speech:"fa-IR", rtl:true},
    {name:"English", translate:"en", speech:"en-US"},
    {name:"FranÃ§ais", translate:"fr", speech:"fr-FR"},
    {name:"Deutsch", translate:"de", speech:"de-DE"},
    {name:"EspaÃ±ol", translate:"es", speech:"es-ES"},
    {name:"Italiano", translate:"it", speech:"it-IT"},
    {name:"PortuguÃªs", translate:"pt", speech:"pt-PT"},
    {name:"Ğ ÑƒÑÑĞºĞ¸Ğ¹", translate:"ru", speech:"ru-RU"},
    {name:"Ğ£ĞºÑ€Ğ°Ñ—Ğ½ÑÑŒĞºĞ°", translate:"uk", speech:"uk-UA"},
    {name:"TÃ¼rkÃ§e", translate:"tr", speech:"tr-TR"},
    {name:"Ø§Ù„Ø¹Ø±Ø¨ÙŠØ©", translate:"ar", speech:"ar-SA", rtl:true},
    {name:"Ø§Ø±Ø¯Ùˆ", translate:"ur", speech:"ur-PK", rtl:true},
    {name:"à¤¹à¤¿à¤¨à¥à¤¦à¥€", translate:"hi", speech:"hi-IN"},
    {name:"à¦¬à¦¾à¦‚à¦²à¦¾", translate:"bn", speech:"bn-BD"},
    {name:"à¨ªà©°à¨œà¨¾à¨¬à©€", translate:"pa", speech:"pa-IN"},
    {name:"àª—à«àªœàª°àª¾àª¤à«€", translate:"gu", speech:"gu-IN"},
    {name:"à®¤à®®à®¿à®´à¯", translate:"ta", speech:"ta-IN"},
    {name:"à°¤à±†à°²à±à°—à±", translate:"te", speech:"te-IN"},
    {name:"à²•à²¨à³à²¨à²¡", translate:"kn", speech:"kn-IN"},
    {name:"à´®à´²à´¯à´¾à´³à´‚", translate:"ml", speech:"ml-IN"},
    {name:"í•œêµ­ì–´", translate:"ko", speech:"ko-KR"},
    {name:"æ—¥æœ¬èª", translate:"ja", speech:"ja-JP"},
    {name:"ä¸­æ–‡ (ç®€ä½“)", translate:"zh-CN", speech:"zh-CN"},
    {name:"ä¸­æ–‡ (ç¹é«”)", translate:"zh-TW", speech:"zh-TW"},
    {name:"à¹„à¸—à¸¢", translate:"th", speech:"th-TH"},
    {name:"Tiáº¿ng Viá»‡t", translate:"vi", speech:"vi-VN"},
    {name:"Bahasa Indonesia", translate:"id", speech:"id-ID"},
    {name:"Bahasa Melayu", translate:"ms", speech:"ms-MY"},
    {name:"Filipino", translate:"tl", speech:"fil-PH"},
    {name:"Nederlands", translate:"nl", speech:"nl-NL"},
    {name:"Svenska", translate:"sv", speech:"sv-SE"},
    {name:"Norsk", translate:"no", speech:"nb-NO"},
    {name:"Dansk", translate:"da", speech:"da-DK"},
    {name:"Suomi", translate:"fi", speech:"fi-FI"},
    {name:"Polski", translate:"pl", speech:"pl-PL"},
    {name:"Î•Î»Î»Î·Î½Î¹ÎºÎ¬", translate:"el", speech:"el-GR"},
    {name:"×¢×‘×¨×™×ª", translate:"he", speech:"he-IL", rtl:true},
    {name:"RomÃ¢nÄƒ", translate:"ro", speech:"ro-RO"},
    {name:"Magyar", translate:"hu", speech:"hu-HU"},
    {name:"ÄŒeÅ¡tina", translate:"cs", speech:"cs-CZ"},
  ];

  function fillLanguageSelects(){
    elSource.innerHTML = "";
    elTarget.innerHTML = "";

    for (const L of LANGS){
      const o1 = document.createElement("option");
      o1.value = L.speech;
      o1.textContent = L.name;
      elSource.appendChild(o1);

      const o2 = document.createElement("option");
      o2.value = L.translate;
      o2.textContent = L.name;
      elTarget.appendChild(o2);
    }

    // defaults
    elSource.value = "fa-IR";
    elTarget.value = "en";
  }

  function setBoxesDirectionByLang(){
    const src = LANGS.find(x => x.speech === elSource.value);
    const tgt = LANGS.find(x => x.translate === elTarget.value);

    const srcRTL = !!src?.rtl;
    const tgtRTL = !!tgt?.rtl;

    elManual.style.direction = srcRTL ? "rtl" : "ltr";
    elOriginal.style.direction = srcRTL ? "rtl" : "ltr";
    elTranslated.style.direction = tgtRTL ? "rtl" : "ltr";

    elOriginal.style.textAlign = "center";
    elTranslated.style.textAlign = "center";
  }

  // --- SpeechRecognition ---
  function initRecognition(){
    const SR = window.SpeechRecognition || window.webkitSpeechRecognition;
    if (!SR) return null;
    const r = new SR();
    r.continuous = false;
    r.interimResults = false;

    r.onresult = async (event) => {
      const text = event.results?.[0]?.[0]?.transcript || "";
      if (!text.trim()) return;

      elOriginal.innerText = text;
      elManual.value = text;

      const target = elTarget.value;
      const translated = await translateText(text, target);

      lastTranslated = translated;
      elTranslated.innerText = translated;
      setAudioButtons(!!translated);

      if (!isIOS) speak(translated, target);
      else showHint("iPhone: Ø¨Ø±Ø§ÛŒ Ø´Ù†ÛŒØ¯Ù† ØµØ¯Ø§ Â«Ù¾Ø®Ø´ ØªØ±Ø¬Ù…Ù‡Â» Ø±Ø§ Ø¨Ø²Ù†. (ÙØ§Ø±Ø³ÛŒ Ú¯ÙØªØ§Ø±ÛŒ Ù…Ù…Ú©Ù† Ø§Ø³Øª Ú©Ø§Ø± Ù†Ú©Ù†Ø¯Ø› Ø§Ø² Dictation Ø§Ø³ØªÙØ§Ø¯Ù‡ Ú©Ù†)");
    };

    r.onerror = () => showHint("ØªØ´Ø®ÛŒØµ ØµØ¯Ø§ Ù…Ø´Ú©Ù„ Ø¯Ø§Ø±Ø¯. Ù…ØªÙ† Ø±Ø§ Ø¯Ø³ØªÛŒ Ø¨Ù†ÙˆÛŒØ³ Ùˆ Â«ØªØ±Ø¬Ù…Ù‡ Ù…ØªÙ†Â» Ø±Ø§ Ø¨Ø²Ù†.");
    return r;
  }
  recognition = initRecognition();

  // --- iOS audio unlock ---
  function unlockAudioOnce(){
    if (audioUnlocked) return;
    audioUnlocked = true;
    try{
      speechSynthesis.cancel();
      const u = new SpeechSynthesisUtterance(" ");
      u.volume = 0;
      speechSynthesis.speak(u);
      speechSynthesis.cancel();
    }catch(_){}
  }
  ["click","touchend"].forEach(evt => document.addEventListener(evt, unlockAudioOnce, {once:true}));

  // --- Speak with best available voice (no picker) ---
  function norm(s){ return (s||"").toLowerCase().replace("_","-"); }
  function getVoicesSafe(){ try { return speechSynthesis.getVoices() || []; } catch(_) { return []; } }

  function bestVoiceFor(langTag){
    const voices = getVoicesSafe();
    if (!voices.length) return null;

    const want = norm(langTag);
    const base = want.split("-")[0];

    const exact = voices.filter(v => norm(v.lang) === want);
    const baseMatch = voices.filter(v => norm(v.lang).startsWith(base));
    const candidates = (exact.length ? exact : baseMatch);

    if (!candidates.length) return null;

    const score = (v) => {
      const n = (v.name||"").toLowerCase();
      let s = 0;
      if (v.default) s += 50;
      if (n.includes("enhanced")) s += 18;
      if (n.includes("premium")) s += 14;
      if (n.includes("google")) s += 12;
      if (n.includes("siri")) s += 10;
      if (n.includes("compact")) s -= 2;
      return s;
    };
    return candidates.slice().sort((a,b)=>score(b)-score(a))[0];
  }

  // iOS voices load late
  speechSynthesis.getVoices();
  speechSynthesis.onvoiceschanged = () => speechSynthesis.getVoices();

  function ttsLangFromTranslateCode(tl){
    // map translate codes to nicer TTS tags when possible
    const map = {
      "en":"en-US","fr":"fr-FR","de":"de-DE","es":"es-ES","it":"it-IT","pt":"pt-PT",
      "ru":"ru-RU","uk":"uk-UA","tr":"tr-TR","ar":"ar-SA","fa":"fa-IR","ur":"ur-PK",
      "hi":"hi-IN","bn":"bn-BD","ta":"ta-IN","te":"te-IN","ml":"ml-IN","ko":"ko-KR",
      "ja":"ja-JP","zh-CN":"zh-CN","zh-TW":"zh-TW","th":"th-TH","vi":"vi-VN","id":"id-ID",
      "nl":"nl-NL","sv":"sv-SE","nb":"nb-NO","da":"da-DK","fi":"fi-FI","pl":"pl-PL","el":"el-GR",
      "he":"he-IL","ro":"ro-RO","hu":"hu-HU","cs":"cs-CZ","ms":"ms-MY","tl":"fil-PH"
    };
    return map[tl] || tl;
  }

  function speak(text, targetTranslateCode){
    if (!text) return;
    try { speechSynthesis.cancel(); } catch(_) {}

    const utter = new SpeechSynthesisUtterance(text);
    const langTag = ttsLangFromTranslateCode(targetTranslateCode);
    utter.lang = langTag;

    const v = bestVoiceFor(langTag);
    if (v) utter.voice = v;

    // Helpful hints for iOS Persian voice
    if (isIOS && targetTranslateCode === "fa" && !v){
      showHint("Ø¨Ø±Ø§ÛŒ ØµØ¯Ø§ÛŒ ÙØ§Ø±Ø³ÛŒ Ø¯Ø± iPhone: Settings â†’ Accessibility â†’ Spoken Content â†’ Voices â†’ Persian Ø±Ø§ Ø¯Ø§Ù†Ù„ÙˆØ¯ Ú©Ù†.");
    }

    speechSynthesis.speak(utter);
  }

  // --- Translation ---
  async function translateText(text, target){
    const res = await fetch(
      "https://translate.googleapis.com/translate_a/single?client=gtx&sl=auto&tl=" +
      target + "&dt=t&q=" + encodeURIComponent(text)
    );
    const data = await res.json();
    return (data?.[0]?.[0]?.[0] || "").toString();
  }

  // --- Buttons ---
  elRecordBtn.addEventListener("click", () => {
    unlockAudioOnce();

    if (!recognition){
      if (isIOS){
        showHint("iPhone: Ø¨Ø±Ø§ÛŒ ÙØ§Ø±Ø³ÛŒ Ø±ÙˆÛŒ Ú©Ø§Ø¯Ø± Ù…ØªÙ† Ø¨Ø²Ù† Ùˆ Ø§Ø² Ù…ÛŒÚ©Ø±ÙˆÙÙˆÙ† Ú©ÛŒØ¨ÙˆØ±Ø¯ (Dictation) Ø§Ø³ØªÙØ§Ø¯Ù‡ Ú©Ù†ØŒ Ø³Ù¾Ø³ Â«ØªØ±Ø¬Ù…Ù‡ Ù…ØªÙ†Â».");
      } else {
        showHint("Ù…Ø±ÙˆØ±Ú¯Ø± Ø´Ù…Ø§ ØªØ´Ø®ÛŒØµ ØµØ¯Ø§ Ø±Ø§ Ù¾Ø´ØªÛŒØ¨Ø§Ù†ÛŒ Ù†Ù…ÛŒâ€ŒÚ©Ù†Ø¯. Ù…ØªÙ† Ø±Ø§ Ø¯Ø³ØªÛŒ Ø¨Ù†ÙˆÛŒØ³.");
      }
      return;
    }

    recognition.lang = elSource.value;
    showHint("Ø¯Ø±Ø­Ø§Ù„ Ú¯ÙˆØ´ Ø¯Ø§Ø¯Ù†â€¦");
    try { recognition.start(); } catch(_) {}
  });

  elTranslateBtn.addEventListener("click", async () => {
    unlockAudioOnce();
    const text = (elManual.value || "").trim();
    if (!text){
      showHint("Ø§ÙˆÙ„ Ù…ØªÙ† Ø¨Ù†ÙˆÛŒØ³ (Ø¯Ø± iPhone Ù…ÛŒâ€ŒØªÙˆØ§Ù†ÛŒ Ø¨Ø§ Dictation Ù…ØªÙ† Ø±Ø§ Ø¨Ú¯ÙˆÛŒÛŒ).");
      return;
    }

    elOriginal.innerText = text;

    const target = elTarget.value;
    const translated = await translateText(text, target);

    lastTranslated = translated;
    elTranslated.innerText = translated;
    setAudioButtons(!!translated);

    if (!isIOS) speak(translated, target);
    else showHint("Ø¨Ø±Ø§ÛŒ Ø´Ù†ÛŒØ¯Ù† ØµØ¯Ø§ Ø¯Ø± iPhone Ø±ÙˆÛŒ Â«Ù¾Ø®Ø´ ØªØ±Ø¬Ù…Ù‡Â» Ø¨Ø²Ù†.");
  });

  elPlayBtn.addEventListener("click", () => {
    unlockAudioOnce();
    if (!lastTranslated) return;
    speak(lastTranslated, elTarget.value);
  });

  elStopBtn.addEventListener("click", () => {
    try { speechSynthesis.cancel(); } catch(_) {}
  });

  elSource.addEventListener("change", setBoxesDirectionByLang);
  elTarget.addEventListener("change", setBoxesDirectionByLang);

  // --- Service Worker ---
  if ("serviceWorker" in navigator) navigator.serviceWorker.register("service-worker.js");

  // Init
  fillLanguageSelects();
  setBoxesDirectionByLang();
  setAudioButtons(false);

  if (isIOS){
    showHint("iPhone: Ø§Ú¯Ø± ÙØ§Ø±Ø³ÛŒ ØµØ­Ø¨Øª Ú©Ø±Ø¯Ù† Ú©Ø§Ø± Ù†Ú©Ø±Ø¯ØŒ Ø§Ø² Dictation Ú©ÛŒØ¨ÙˆØ±Ø¯ Ø¯Ø§Ø®Ù„ Ú©Ø§Ø¯Ø± Ù…ØªÙ† Ø§Ø³ØªÙØ§Ø¯Ù‡ Ú©Ù†. ØµØ¯Ø§ ÙÙ‚Ø· Ø¨Ø§ Â«Ù¾Ø®Ø´ ØªØ±Ø¬Ù…Ù‡Â» Ù¾Ø®Ø´ Ù…ÛŒâ€ŒØ´ÙˆØ¯.");
  } else {
    showHint("Ø¢Ù…Ø§Ø¯Ù‡ âœ… ØµØ­Ø¨Øª Ú©Ù† ÛŒØ§ Ù…ØªÙ† Ø¨Ù†ÙˆÛŒØ³Ø› ØªØ±Ø¬Ù…Ù‡ Ø§Ù†Ø¬Ø§Ù… Ù…ÛŒâ€ŒØ´ÙˆØ¯.");
  }
</script>
</body>
</html>
