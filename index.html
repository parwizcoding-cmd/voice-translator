<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <title>Voice Translator</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="theme-color" content="#0B1220">
  <link rel="manifest" href="manifest.json">

  <style>
    :root{
      --bg1:#0B1220;
      --bg2:#0E1B2E;
      --card: rgba(255,255,255,0.06);
      --card2: rgba(255,255,255,0.08);
      --stroke: rgba(255,255,255,0.14);
      --text: rgba(255,255,255,0.92);
      --muted: rgba(255,255,255,0.70);
      --accent:#7C3AED;   /* purple */
      --accent2:#22C55E;  /* green */
      --warn:#F59E0B;
    }

    *{box-sizing:border-box}

    body{
      margin:0;
      font-family: "Segoe UI", Tahoma, sans-serif;
      color: var(--text);
      min-height:100vh;
      display:flex;
      justify-content:center;
      align-items:center;
      padding:18px;
      background:
        radial-gradient(900px 500px at 20% 15%, rgba(124,58,237,0.35), transparent 55%),
        radial-gradient(900px 500px at 80% 20%, rgba(34,197,94,0.25), transparent 55%),
        linear-gradient(135deg, var(--bg1), var(--bg2));
    }

    .wrap{
      width:100%;
      max-width:560px;
    }

    .card{
      background: var(--card);
      border: 1px solid var(--stroke);
      border-radius: 22px;
      padding: 18px;
      box-shadow: 0 25px 60px rgba(0,0,0,0.45);
      backdrop-filter: blur(10px);
    }

    .header{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:12px;
      margin-bottom: 10px;
    }

    .title{
      display:flex;
      flex-direction:column;
      gap:2px;
      text-align:right;
    }

    h1{
      margin:0;
      font-size: 22px;
      letter-spacing: .2px;
    }

    .sub{
      margin:0;
      font-size: 12px;
      color: var(--muted);
    }

    .pill{
      display:inline-flex;
      align-items:center;
      gap:8px;
      padding: 8px 10px;
      border-radius: 999px;
      background: rgba(255,255,255,0.08);
      border: 1px solid rgba(255,255,255,0.12);
      color: rgba(255,255,255,0.88);
      font-size: 12px;
      white-space: nowrap;
    }

    .grid{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap:10px;
      margin-top: 10px;
    }

    label{
      display:block;
      text-align:center;
      font-size: 12px;
      color: var(--muted);
      margin-top: 2px;
      margin-bottom: 6px;
    }

    select, textarea, button{
      width:100%;
      border-radius: 14px;
      border: 1px solid rgba(255,255,255,0.12);
      background: rgba(16,23,40,0.65);
      color: var(--text);
      padding: 12px 12px;
      font-size: 15px;
      outline: none;
    }

    select:focus, textarea:focus{
      border-color: rgba(124,58,237,0.55);
      box-shadow: 0 0 0 3px rgba(124,58,237,0.18);
    }

    textarea{
      min-height: 92px;
      resize: vertical;
      direction: rtl;
      text-align: center;
      margin-top: 10px;
    }

    .btnRow{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap:10px;
      margin-top: 10px;
    }

    button{
      cursor:pointer;
      font-weight: 700;
      transition: transform .12s ease, filter .12s ease, border-color .12s ease;
    }

    button:active{ transform: scale(0.98); }

    .primary{
      background: linear-gradient(135deg, var(--accent), #A78BFA);
      border-color: rgba(167,139,250,0.35);
      color: #0B1220;
    }

    .secondary{
      background: rgba(255,255,255,0.06);
      border-color: rgba(255,255,255,0.14);
      color: var(--text);
    }

    .danger{
      background: rgba(239,68,68,0.10);
      border-color: rgba(239,68,68,0.35);
      color: rgba(255,255,255,0.92);
    }

    button:disabled{
      opacity:0.55;
      cursor:not-allowed;
      transform:none;
    }

    .boxes{
      margin-top: 12px;
      display:grid;
      grid-template-columns: 1fr;
      gap:10px;
    }

    .box{
      background: rgba(255,255,255,0.06);
      border: 1px solid rgba(255,255,255,0.12);
      border-radius: 16px;
      padding: 12px;
      min-height: 62px;
      text-align: center;
      word-break: break-word;
      display:flex;
      align-items:center;
      justify-content:center;
    }

    .hint{
      margin-top: 10px;
      font-size: 12px;
      color: var(--muted);
      text-align: center;
      line-height: 1.6;
      min-height: 18px;
    }

    .footer{
      margin-top: 12px;
      font-size: 12px;
      color: rgba(255,255,255,0.55);
      text-align:center;
    }

    @media (max-width: 420px){
      .grid{ grid-template-columns: 1fr; }
      .btnRow{ grid-template-columns: 1fr; }
    }
  </style>
</head>
<body>
  <div class="wrap">
    <div class="card">

      <div class="header">
        <div class="title">
          <h1>Voice Translator</h1>
          <p class="sub">ØªØ±Ø¬Ù…Ù‡ ØµÙˆØªÛŒ Ùˆ Ù…ØªÙ†ÛŒ Ø¨Ø§ Ø·Ø±Ø§Ø­ÛŒ Ù…Ø¯Ø±Ù†</p>
        </div>
        <div class="pill" id="platformPill">Ø¯Ø±Ø­Ø§Ù„ Ø¨Ø±Ø±Ø³ÛŒâ€¦</div>
      </div>

      <div class="grid">
        <div>
          <label>Ø²Ø¨Ø§Ù† ÙˆØ±ÙˆØ¯ÛŒ</label>
          <select id="sourceLang"></select>
        </div>
        <div>
          <label>Ø²Ø¨Ø§Ù† Ù…Ù‚ØµØ¯</label>
          <select id="targetLang"></select>
        </div>
      </div>

      <textarea id="manualInput" placeholder="Ù…ØªÙ† Ø±Ø§ Ø§ÛŒÙ†Ø¬Ø§ Ø¨Ù†ÙˆÛŒØ³â€¦ (Ø§Ú¯Ø± ØµØ¯Ø§ Ú©Ø§Ø± Ù†Ú©Ø±Ø¯ØŒ Ø¯Ø³ØªÛŒ Ø¨Ù†ÙˆÛŒØ³)"></textarea>

      <div class="btnRow">
        <button id="recordBtn" class="primary">ğŸ™ Ø´Ø±ÙˆØ¹ ØµØ­Ø¨Øª</button>
        <button id="translateBtn" class="secondary">ğŸ” ØªØ±Ø¬Ù…Ù‡ Ù…ØªÙ†</button>
      </div>

      <div class="btnRow">
        <button id="playBtn" class="secondary" disabled>ğŸ”Š Ù¾Ø®Ø´ ØªØ±Ø¬Ù…Ù‡</button>
        <button id="stopBtn" class="danger" disabled>â¹ ØªÙˆÙ‚Ù ØµØ¯Ø§</button>
      </div>

      <div class="boxes">
        <div class="box" id="originalText">Ù…ØªÙ† ÙˆØ±ÙˆØ¯ÛŒâ€¦</div>
        <div class="box" id="translatedText">ØªØ±Ø¬Ù…Ù‡â€¦</div>
      </div>

      <div class="hint" id="hintText"></div>
      <div class="footer">PWA â€¢ Works on Android / iPhone</div>
    </div>
  </div>

<script>
  // --- Detect iOS ---
  const isIOS = (() => {
    const ua = navigator.userAgent || "";
    const iOS = /iPad|iPhone|iPod/.test(ua);
    const iPadOS = (ua.includes("Mac") && "ontouchend" in document);
    return iOS || iPadOS;
  })();

  const elSource = document.getElementById("sourceLang");
  const elTarget = document.getElementById("targetLang");
  const elRecordBtn = document.getElementById("recordBtn");
  const elTranslateBtn = document.getElementById("translateBtn");
  const elPlayBtn = document.getElementById("playBtn");
  const elStopBtn = document.getElementById("stopBtn");
  const elOriginal = document.getElementById("originalText");
  const elTranslated = document.getElementById("translatedText");
  const elManual = document.getElementById("manualInput");
  const elHint = document.getElementById("hintText");
  const elPill = document.getElementById("platformPill");

  elPill.textContent = isIOS ? "ğŸ iPhone/iOS" : "ğŸ¤– Android/Desktop";

  let recognition = null;
  let lastTranslated = "";
  let audioUnlocked = false;

  function showHint(msg){ elHint.textContent = msg || ""; }
  function setAudioButtons(hasText){
    elPlayBtn.disabled = !hasText;
    elStopBtn.disabled = !hasText;
  }

  // Big language list
  const LANGS = [
    {name:"ÙØ§Ø±Ø³ÛŒ", translate:"fa", speech:"fa-IR", rtl:true},
    {name:"English", translate:"en", speech:"en-US"},
    {name:"FranÃ§ais", translate:"fr", speech:"fr-FR"},
    {name:"Deutsch", translate:"de", speech:"de-DE"},
    {name:"EspaÃ±ol", translate:"es", speech:"es-ES"},
    {name:"Italiano", translate:"it", speech:"it-IT"},
    {name:"PortuguÃªs", translate:"pt", speech:"pt-PT"},
    {name:"Ğ ÑƒÑÑĞºĞ¸Ğ¹", translate:"ru", speech:"ru-RU"},
    {name:"TÃ¼rkÃ§e", translate:"tr", speech:"tr-TR"},
    {name:"Ø§Ù„Ø¹Ø±Ø¨ÙŠØ©", translate:"ar", speech:"ar-SA", rtl:true},
    {name:"Ø§Ø±Ø¯Ùˆ", translate:"ur", speech:"ur-PK", rtl:true},
    {name:"à¤¹à¤¿à¤¨à¥à¤¦à¥€", translate:"hi", speech:"hi-IN"},
    {name:"à¦¬à¦¾à¦‚à¦²à¦¾", translate:"bn", speech:"bn-BD"},
    {name:"à®¤à®®à®¿à®´à¯", translate:"ta", speech:"ta-IN"},
    {name:"à°¤à±†à°²à±à°—à±", translate:"te", speech:"te-IN"},
    {name:"í•œêµ­ì–´", translate:"ko", speech:"ko-KR"},
    {name:"æ—¥æœ¬èª", translate:"ja", speech:"ja-JP"},
    {name:"ä¸­æ–‡ (ç®€ä½“)", translate:"zh-CN", speech:"zh-CN"},
    {name:"ä¸­æ–‡ (ç¹é«”)", translate:"zh-TW", speech:"zh-TW"},
    {name:"à¹„à¸—à¸¢", translate:"th", speech:"th-TH"},
    {name:"Tiáº¿ng Viá»‡t", translate:"vi", speech:"vi-VN"},
    {name:"Bahasa Indonesia", translate:"id", speech:"id-ID"},
    {name:"Nederlands", translate:"nl", speech:"nl-NL"},
    {name:"Svenska", translate:"sv", speech:"sv-SE"},
    {name:"Polski", translate:"pl", speech:"pl-PL"},
    {name:"Î•Î»Î»Î·Î½Î¹ÎºÎ¬", translate:"el", speech:"el-GR"},
    {name:"×¢×‘×¨×™×ª", translate:"he", speech:"he-IL", rtl:true},
    {name:"RomÃ¢nÄƒ", translate:"ro", speech:"ro-RO"},
    {name:"Magyar", translate:"hu", speech:"hu-HU"},
    {name:"ÄŒeÅ¡tina", translate:"cs", speech:"cs-CZ"},
  ];

  function fillLanguageSelects(){
    elSource.innerHTML = "";
    elTarget.innerHTML = "";
    for (const L of LANGS){
      const o1 = document.createElement("option");
      o1.value = L.speech;
      o1.textContent = L.name;
      elSource.appendChild(o1);

      const o2 = document.createElement("option");
      o2.value = L.translate;
      o2.textContent = L.name;
      elTarget.appendChild(o2);
    }
    elSource.value = "fa-IR";
    elTarget.value = "en";
  }

  function setDirections(){
    const src = LANGS.find(x => x.speech === elSource.value);
    const tgt = LANGS.find(x => x.translate === elTarget.value);

    const srcRTL = !!src?.rtl;
    const tgtRTL = !!tgt?.rtl;

    elManual.style.direction = srcRTL ? "rtl" : "ltr";
    elManual.style.textAlign = "center";

    elOriginal.style.direction = srcRTL ? "rtl" : "ltr";
    elTranslated.style.direction = tgtRTL ? "rtl" : "ltr";
  }

  // SpeechRecognition
  function initRecognition(){
    const SR = window.SpeechRecognition || window.webkitSpeechRecognition;
    if (!SR) return null;
    const r = new SR();
    r.continuous = false;
    r.interimResults = false;

    r.onresult = async (event) => {
      const text = event.results?.[0]?.[0]?.transcript || "";
      if (!text.trim()) return;

      elOriginal.innerText = text;
      elManual.value = text;

      const target = elTarget.value;
      const translated = await translateText(text, target);

      lastTranslated = translated;
      elTranslated.innerText = translated;
      setAudioButtons(!!translated);

      // iOS: don't auto speak
      if (!isIOS) speak(translated, target);
      else showHint("Ø¨Ø±Ø§ÛŒ Ø´Ù†ÛŒØ¯Ù† ØµØ¯Ø§ Ø±ÙˆÛŒ Â«Ù¾Ø®Ø´ ØªØ±Ø¬Ù…Ù‡Â» Ø¨Ø²Ù†.");
    };

    r.onerror = () => showHint("ØªØ´Ø®ÛŒØµ ØµØ¯Ø§ Ù…Ø´Ú©Ù„ Ø¯Ø§Ø±Ø¯. Ù…ØªÙ† Ø±Ø§ Ø¯Ø³ØªÛŒ Ø¨Ù†ÙˆÛŒØ³ Ùˆ Â«ØªØ±Ø¬Ù…Ù‡ Ù…ØªÙ†Â» Ø±Ø§ Ø¨Ø²Ù†.");
    return r;
  }
  recognition = initRecognition();

  // iOS audio unlock
  function unlockAudioOnce(){
    if (audioUnlocked) return;
    audioUnlocked = true;
    try{
      speechSynthesis.cancel();
      const u = new SpeechSynthesisUtterance(" ");
      u.volume = 0;
      speechSynthesis.speak(u);
      speechSynthesis.cancel();
    }catch(_){}
  }
  ["click","touchend"].forEach(evt => document.addEventListener(evt, unlockAudioOnce, {once:true}));

  // Voice picking (automatic best, no UI)
  function norm(s){ return (s||"").toLowerCase().replace("_","-"); }
  function getVoicesSafe(){ try { return speechSynthesis.getVoices() || []; } catch(_) { return []; } }

  function bestVoiceFor(langTag){
    const voices = getVoicesSafe();
    if (!voices.length) return null;

    const want = norm(langTag);
    const base = want.split("-")[0];

    const exact = voices.filter(v => norm(v.lang) === want);
    const baseMatch = voices.filter(v => norm(v.lang).startsWith(base));
    const candidates = (exact.length ? exact : baseMatch);
    if (!candidates.length) return null;

    const score = (v) => {
      const n = (v.name||"").toLowerCase();
      let s = 0;
      if (v.default) s += 50;
      if (n.includes("enhanced")) s += 18;
      if (n.includes("premium")) s += 14;
      if (n.includes("google")) s += 12;
      if (n.includes("siri")) s += 10;
      if (n.includes("compact")) s -= 2;
      return s;
    };
    return candidates.slice().sort((a,b)=>score(b)-score(a))[0];
  }

  speechSynthesis.getVoices();
  speechSynthesis.onvoiceschanged = () => speechSynthesis.getVoices();

  function ttsLangFromTL(tl){
    const map = {
      "en":"en-US","fr":"fr-FR","de":"de-DE","es":"es-ES","it":"it-IT","pt":"pt-PT",
      "ru":"ru-RU","tr":"tr-TR","ar":"ar-SA","fa":"fa-IR","ur":"ur-PK","hi":"hi-IN",
      "bn":"bn-BD","ta":"ta-IN","te":"te-IN","ko":"ko-KR","ja":"ja-JP","zh-CN":"zh-CN",
      "zh-TW":"zh-TW","th":"th-TH","vi":"vi-VN","id":"id-ID","nl":"nl-NL","sv":"sv-SE",
      "pl":"pl-PL","el":"el-GR","he":"he-IL","ro":"ro-RO","hu":"hu-HU","cs":"cs-CZ"
    };
    return map[tl] || tl;
  }

  function speak(text, targetTL){
    if (!text) return;
    try { speechSynthesis.cancel(); } catch(_) {}

    const utter = new SpeechSynthesisUtterance(text);
    const langTag = ttsLangFromTL(targetTL);
    utter.lang = langTag;

    const v = bestVoiceFor(langTag);
    if (v) utter.voice = v;

    speechSynthesis.speak(utter);
  }

  async function translateText(text, target){
    const res = await fetch(
      "https://translate.googleapis.com/translate_a/single?client=gtx&sl=auto&tl=" +
      target + "&dt=t&q=" + encodeURIComponent(text)
    );
    const data = await res.json();
    return (data?.[0]?.[0]?.[0] || "").toString();
  }

  // Buttons
  elRecordBtn.addEventListener("click", () => {
    unlockAudioOnce();
    if (!recognition){
      showHint("Ø§ÛŒÙ† Ù…Ø±ÙˆØ±Ú¯Ø± ØªØ´Ø®ÛŒØµ ØµØ¯Ø§ Ø±Ø§ Ù¾Ø´ØªÛŒØ¨Ø§Ù†ÛŒ Ù†Ù…ÛŒâ€ŒÚ©Ù†Ø¯. Ù…ØªÙ† Ø±Ø§ Ø¯Ø³ØªÛŒ Ø¨Ù†ÙˆÛŒØ³.");
      return;
    }
    recognition.lang = elSource.value;
    showHint("Ø¯Ø±Ø­Ø§Ù„ Ú¯ÙˆØ´ Ø¯Ø§Ø¯Ù†â€¦");
    try { recognition.start(); } catch(_) {}
  });

  elTranslateBtn.addEventListener("click", async () => {
    unlockAudioOnce();
    const text = (elManual.value || "").trim();
    if (!text){
      showHint("Ø§ÙˆÙ„ Ù…ØªÙ† Ø¨Ù†ÙˆÛŒØ³.");
      return;
    }

    elOriginal.innerText = text;
    const target = elTarget.value;
    const translated = await translateText(text, target);

    lastTranslated = translated;
    elTranslated.innerText = translated;
    setAudioButtons(!!translated);

    if (!isIOS) speak(translated, target);
    else showHint("Ø¨Ø±Ø§ÛŒ Ø´Ù†ÛŒØ¯Ù† ØµØ¯Ø§ Ø±ÙˆÛŒ Â«Ù¾Ø®Ø´ ØªØ±Ø¬Ù…Ù‡Â» Ø¨Ø²Ù†.");
  });

  elPlayBtn.addEventListener("click", () => {
    unlockAudioOnce();
    if (!lastTranslated) return;
    speak(lastTranslated, elTarget.value);
  });

  elStopBtn.addEventListener("click", () => {
    try { speechSynthesis.cancel(); } catch(_) {}
  });

  elSource.addEventListener("change", setDirections);
  elTarget.addEventListener("change", setDirections);

  // Service Worker
  if ("serviceWorker" in navigator) navigator.serviceWorker.register("service-worker.js");

  // Init
  fillLanguageSelects();
  setDirections();
  setAudioButtons(false);
  showHint(isIOS ? "Ø¯Ø± Ø¢ÛŒÙÙˆÙ† Ø¨Ø±Ø§ÛŒ ØµØ¯Ø§ Ø±ÙˆÛŒ Â«Ù¾Ø®Ø´ ØªØ±Ø¬Ù…Ù‡Â» Ø¨Ø²Ù†." : "Ø¢Ù…Ø§Ø¯Ù‡ âœ…");
</script>
</body>
</html>
