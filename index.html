<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <title>Voice Translator</title>

  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="theme-color" content="#00E676">

  <link rel="manifest" href="manifest.json">

  <style>
    body {
      margin: 0;
      font-family: "Segoe UI", Tahoma, sans-serif;
      background: linear-gradient(135deg, #0f2027, #203a43, #2c5364);
      color: #fff;
      min-height: 100vh;
      display: flex;
      justify-content: center;
      align-items: center;
      padding: 18px;
      box-sizing: border-box;
    }

    .card {
      background: #121212;
      border-radius: 20px;
      padding: 22px;
      width: 100%;
      max-width: 460px;
      box-shadow: 0 20px 40px rgba(0,0,0,.5);
      text-align: center;
    }

    h1 {
      margin: 0 0 6px 0;
      color: #00E676;
      font-size: 26px;
    }

    .pill {
      display: inline-block;
      padding: 6px 10px;
      border-radius: 999px;
      background: rgba(0,230,118,0.12);
      border: 1px solid rgba(0,230,118,0.35);
      color: #b9ffd8;
      font-size: 12px;
      margin: 8px 0 12px 0;
    }

    select, button, textarea {
      width: 100%;
      padding: 12px;
      margin-top: 10px;
      border-radius: 12px;
      border: none;
      font-size: 16px;
      box-sizing: border-box;
    }

    select, textarea {
      background: #1e1e1e;
      color: #fff;
    }

    textarea {
      resize: vertical;
      min-height: 74px;
      direction: rtl;
    }

    .row {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 10px;
      margin-top: 10px;
    }

    button {
      background: #00E676;
      color: #000;
      font-weight: bold;
      cursor: pointer;
      transition: transform .15s ease;
    }

    button.secondary {
      background: #2a2a2a;
      color: #fff;
      border: 1px solid rgba(255,255,255,0.12);
    }

    button:disabled {
      opacity: 0.55;
      cursor: not-allowed;
    }

    button:active {
      transform: scale(0.97);
    }

    .box {
      background: #1e1e1e;
      border-radius: 12px;
      padding: 12px;
      margin-top: 12px;
      min-height: 60px;
      direction: rtl;
      text-align: center;
      word-break: break-word;
    }

    .hint {
      margin-top: 10px;
      font-size: 12px;
      opacity: .85;
      line-height: 1.6;
    }

    footer {
      margin-top: 14px;
      font-size: 12px;
      opacity: .7;
    }
  </style>
</head>
<body>

  <div class="card">
    <h1>ğŸ¤ Ù…ØªØ±Ø¬Ù… ØµÙˆØªÛŒ</h1>
    <div class="pill" id="platformPill">Ø¯Ø±Ø­Ø§Ù„ Ø¨Ø±Ø±Ø³ÛŒ Ø¯Ø³ØªÚ¯Ø§Ù‡â€¦</div>

    <select id="sourceLang" aria-label="Ø²Ø¨Ø§Ù† ÙˆØ±ÙˆØ¯ÛŒ">
      <option value="fa-IR">ÙØ§Ø±Ø³ÛŒ</option>
      <option value="en-US">English</option>
      <option value="fr-FR">FranÃ§ais</option>
      <option value="de-DE">Deutsch</option>
      <option value="tr-TR">TÃ¼rkÃ§e</option>
      <option value="ar-SA">Ø§Ù„Ø¹Ø±Ø¨ÙŠØ©</option>
    </select>

    <select id="targetLang" aria-label="Ø²Ø¨Ø§Ù† Ù…Ù‚ØµØ¯">
      <option value="en">English</option>
      <option value="fa">ÙØ§Ø±Ø³ÛŒ</option>
      <option value="fr">FranÃ§ais</option>
      <option value="de">Deutsch</option>
      <option value="tr">TÃ¼rkÃ§e</option>
      <option value="ar">Ø§Ù„Ø¹Ø±Ø¨ÙŠØ©</option>
    </select>

    <textarea id="manualInput" placeholder="Ø§Ú¯Ø± ØµØ¯Ø§ Ú©Ø§Ø± Ù†Ú©Ø±Ø¯ØŒ Ù…ØªÙ† Ø±Ø§ Ø§ÛŒÙ†Ø¬Ø§ Ø¨Ù†ÙˆÛŒØ³â€¦"></textarea>

    <div class="row">
      <button id="recordBtn">ğŸ™ Ø´Ø±ÙˆØ¹ ØµØ­Ø¨Øª</button>
      <button id="translateBtn" class="secondary">ğŸ” ØªØ±Ø¬Ù…Ù‡ Ù…ØªÙ†</button>
    </div>

    <div class="row">
      <button id="playBtn" class="secondary" disabled>ğŸ”Š Ù¾Ø®Ø´ ØªØ±Ø¬Ù…Ù‡</button>
      <button id="stopBtn" class="secondary" disabled>â¹ ØªÙˆÙ‚Ù ØµØ¯Ø§</button>
    </div>

    <div class="box" id="originalText">Ù…ØªÙ† ÙˆØ±ÙˆØ¯ÛŒâ€¦</div>
    <div class="box" id="translatedText">ØªØ±Ø¬Ù…Ù‡â€¦</div>

    <div class="hint" id="hintText"></div>
    <footer>Voice Translator PWA</footer>
  </div>

<script>
  // --- Platform detect (iPhone/iPad) ---
  const isIOS = (() => {
    const ua = navigator.userAgent || "";
    const iOS = /iPad|iPhone|iPod/.test(ua);
    const iPadOS = (ua.includes("Mac") && "ontouchend" in document);
    return iOS || iPadOS;
  })();

  const elSource = document.getElementById("sourceLang");
  const elTarget = document.getElementById("targetLang");
  const elRecordBtn = document.getElementById("recordBtn");
  const elTranslateBtn = document.getElementById("translateBtn");
  const elPlayBtn = document.getElementById("playBtn");
  const elStopBtn = document.getElementById("stopBtn");
  const elOriginal = document.getElementById("originalText");
  const elTranslated = document.getElementById("translatedText");
  const elManual = document.getElementById("manualInput");
  const elHint = document.getElementById("hintText");
  const elPill = document.getElementById("platformPill");

  elPill.textContent = isIOS ? "ğŸ iPhone/iOS" : "ğŸ¤– Android/Desktop";

  let recognition = null;
  let lastTranslated = "";
  let audioUnlocked = false;

  function showHint(msg) { elHint.textContent = msg || ""; }
  function setAudioButtons(hasText) {
    elPlayBtn.disabled = !hasText;
    elStopBtn.disabled = !hasText;
  }

  // Map target language (translate code) -> TTS BCP-47 tag
  function getTTSLang(target) {
    const map = {
      fa: "fa-IR",
      en: "en-US",
      fr: "fr-FR",
      de: "de-DE",
      tr: "tr-TR",
      ar: "ar-SA",
    };
    return map[target] || target;
  }

  // --- SpeechRecognition (Chrome/Android usually, iOS often not) ---
  function initRecognition() {
    const SR = window.SpeechRecognition || window.webkitSpeechRecognition;
    if (!SR) return null;

    const r = new SR();
    r.continuous = false;
    r.interimResults = false;

    r.onresult = async (event) => {
      const text = event.results?.[0]?.[0]?.transcript || "";
      if (!text.trim()) return;

      elOriginal.innerText = text;
      elManual.value = text;

      const target = elTarget.value;
      const translated = await translateText(text, target);

      lastTranslated = translated;
      elTranslated.innerText = translated;
      setAudioButtons(!!translated);

      // iOS blocks auto speak; user must tap Play
      if (!isIOS) {
        speak(translated, target);
      } else {
        showHint("Ø¯Ø± Ø¢ÛŒÙÙˆÙ† Ø¨Ø±Ø§ÛŒ Ø´Ù†ÛŒØ¯Ù† ØµØ¯Ø§ Ø­ØªÙ…Ø§Ù‹ Ø±ÙˆÛŒ Â«Ù¾Ø®Ø´ ØªØ±Ø¬Ù…Ù‡Â» Ø¨Ø²Ù†. (Ø§Ú¯Ø± ÙØ§Ø±Ø³ÛŒ ØµØ¯Ø§ Ù†Ø¯Ø§Ø±Ø¯ØŒ Persian Voice Ø±Ø§ Ø§Ø² ØªÙ†Ø¸ÛŒÙ…Ø§Øª iOS Ø¯Ø§Ù†Ù„ÙˆØ¯ Ú©Ù†)");
      }
    };

    r.onerror = () => {
      showHint("ØªØ´Ø®ÛŒØµ ØµØ¯Ø§ Ù…Ø´Ú©Ù„ Ø¯Ø§Ø±Ø¯. Ù…ØªÙ† Ø±Ø§ Ø¯Ø³ØªÛŒ Ø¨Ù†ÙˆÛŒØ³ Ùˆ Â«ØªØ±Ø¬Ù…Ù‡ Ù…ØªÙ†Â» Ø±Ø§ Ø¨Ø²Ù†.");
    };

    return r;
  }

  recognition = initRecognition();

  // --- iOS audio unlock (must be triggered by user gesture) ---
  function unlockAudioOnce() {
    if (audioUnlocked) return;
    audioUnlocked = true;
    try {
      speechSynthesis.cancel();
      const u = new SpeechSynthesisUtterance(" ");
      u.volume = 0;
      speechSynthesis.speak(u);
      speechSynthesis.cancel();
    } catch (_) {}
  }

  ["click", "touchend"].forEach(evt => {
    document.addEventListener(evt, () => unlockAudioOnce(), { once: true });
  });

  // --- Better voice picking (improves pronunciation when voices exist) ---
  function normalizeLang(s) {
    return (s || "").toLowerCase().replace("_", "-");
  }

  function pickBestVoice(langTag) {
    const voices = speechSynthesis.getVoices() || [];
    if (!voices.length) return null;

    const want = normalizeLang(langTag);
    const base = want.split("-")[0];

    // Prefer: exact match, then same base language, prefer local/service voices.
    const exact = voices.filter(v => normalizeLang(v.lang) === want);
    const baseMatch = voices.filter(v => normalizeLang(v.lang).startsWith(base));

    const preferredOrder = (arr) => {
      // Put default voice first, then voices containing "google" / "enhanced" / "premium" / "siri" (varies by platform)
      const score = (v) => {
        const name = (v.name || "").toLowerCase();
        let s = 0;
        if (v.default) s += 50;
        if (name.includes("google")) s += 20;
        if (name.includes("enhanced")) s += 15;
        if (name.includes("premium")) s += 12;
        if (name.includes("siri")) s += 10;
        if (name.includes("compact")) s -= 2;
        return s;
      };
      return arr.slice().sort((a,b) => score(b)-score(a));
    };

    let candidates = exact.length ? exact : baseMatch;
    candidates = preferredOrder(candidates);

    return candidates[0] || null;
  }

  // iOS loads voices late sometimes; this helps
  speechSynthesis.getVoices();
  speechSynthesis.onvoiceschanged = () => { speechSynthesis.getVoices(); };

  function speak(text, targetLang) {
    if (!text) return;

    try { speechSynthesis.cancel(); } catch (_) {}

    const utter = new SpeechSynthesisUtterance(text);
    const ttsLang = getTTSLang(targetLang);
    utter.lang = ttsLang;

    const v = pickBestVoice(ttsLang);
    if (v) {
      utter.voice = v;
    } else {
      // If voice doesn't exist (common for fa on iOS), show a helpful hint
      const base = ttsLang.split("-")[0].toLowerCase();
      if (isIOS && base === "fa") {
        showHint("Ø¨Ø±Ø§ÛŒ ØµØ¯Ø§ÛŒ ÙØ§Ø±Ø³ÛŒ Ø¯Ø± Ø¢ÛŒÙÙˆÙ†: Settings â†’ Accessibility â†’ Spoken Content â†’ Voices â†’ Persian Ø±Ø§ Ø¯Ø§Ù†Ù„ÙˆØ¯ Ú©Ù†ØŒ Ø³Ù¾Ø³ Ø¯ÙˆØ¨Ø§Ø±Ù‡ Ø§Ù…ØªØ­Ø§Ù† Ú©Ù†.");
      }
    }

    speechSynthesis.speak(utter);
  }

  // --- Translate via Google Translate public endpoint (text only) ---
  async function translateText(text, target) {
    const res = await fetch(
      "https://translate.googleapis.com/translate_a/single?client=gtx&sl=auto&tl=" +
      target + "&dt=t&q=" + encodeURIComponent(text)
    );
    const data = await res.json();
    return (data?.[0]?.[0]?.[0] || "").toString();
  }

  // --- Buttons ---
  elRecordBtn.addEventListener("click", () => {
    unlockAudioOnce();

    if (!recognition) {
      showHint("ØªØ´Ø®ÛŒØµ ØµØ¯Ø§ Ø¯Ø± Ø§ÛŒÙ† Ù…Ø±ÙˆØ±Ú¯Ø±/Ø¢ÛŒÙÙˆÙ† Ù…Ø­Ø¯ÙˆØ¯ Ø§Ø³Øª. Ù…ØªÙ† Ø±Ø§ Ø¯Ø³ØªÛŒ Ø¨Ù†ÙˆÛŒØ³ Ùˆ Â«ØªØ±Ø¬Ù…Ù‡ Ù…ØªÙ†Â» Ø±Ø§ Ø¨Ø²Ù†.");
      return;
    }

    recognition.lang = elSource.value;
    showHint("Ø¯Ø±Ø­Ø§Ù„ Ú¯ÙˆØ´ Ø¯Ø§Ø¯Ù†â€¦ Ø§Ú¯Ø± Ú©Ø§Ø± Ù†Ú©Ø±Ø¯ØŒ Ù…ØªÙ† Ø±Ø§ Ø¯Ø³ØªÛŒ Ø¨Ù†ÙˆÛŒØ³.");
    try { recognition.start(); } catch (_) {}
  });

  elTranslateBtn.addEventListener("click", async () => {
    unlockAudioOnce();

    const text = (elManual.value || "").trim();
    if (!text) {
      showHint("Ø§ÙˆÙ„ ÛŒÚ© Ù…ØªÙ† Ø¨Ù†ÙˆÛŒØ³ ÛŒØ§ Ø¨Ø§ Ø¯Ú©Ù…Ù‡ Â«Ø´Ø±ÙˆØ¹ ØµØ­Ø¨ØªÂ» ØµØ­Ø¨Øª Ú©Ù†.");
      return;
    }

    elOriginal.innerText = text;

    const target = elTarget.value;
    const translated = await translateText(text, target);

    lastTranslated = translated;
    elTranslated.innerText = translated;
    setAudioButtons(!!translated);

    // Android/Desktop: auto speak feels good
    if (!isIOS) speak(translated, target);
    else showHint("Ø¨Ø±Ø§ÛŒ Ø´Ù†ÛŒØ¯Ù† ØµØ¯Ø§ Ø¯Ø± Ø¢ÛŒÙÙˆÙ† Ø±ÙˆÛŒ Â«Ù¾Ø®Ø´ ØªØ±Ø¬Ù…Ù‡Â» Ø¨Ø²Ù†.");
  });

  elPlayBtn.addEventListener("click", () => {
    unlockAudioOnce();
    if (!lastTranslated) return;
    speak(lastTranslated, elTarget.value);
  });

  elStopBtn.addEventListener("click", () => {
    try { speechSynthesis.cancel(); } catch (_) {}
  });

  // --- Service Worker ---
  if ("serviceWorker" in navigator) {
    navigator.serviceWorker.register("service-worker.js");
  }

  // Initial hint
  if (isIOS) {
    showHint("Ù†Ú©ØªÙ‡ Ø¢ÛŒÙÙˆÙ†: Ø¨Ø±Ø§ÛŒ Ø´Ù†ÛŒØ¯Ù† ØµØ¯Ø§ Ø­ØªÙ…Ø§Ù‹ Â«Ù¾Ø®Ø´ ØªØ±Ø¬Ù…Ù‡Â» Ø±Ø§ Ø¨Ø²Ù†. Ø§Ú¯Ø± ÙØ§Ø±Ø³ÛŒ ØµØ¯Ø§ Ù†Ø¯Ø§Ø±Ø¯ØŒ Persian Voice Ø±Ø§ Ø§Ø² ØªÙ†Ø¸ÛŒÙ…Ø§Øª iOS Ø¯Ø§Ù†Ù„ÙˆØ¯ Ú©Ù†.");
  } else {
    showHint("Ø¢Ù…Ø§Ø¯Ù‡ âœ… ØµØ­Ø¨Øª Ú©Ù† ÛŒØ§ Ù…ØªÙ† Ø¨Ù†ÙˆÛŒØ³Ø› ØªØ±Ø¬Ù…Ù‡ Ø§Ù†Ø¬Ø§Ù… Ù…ÛŒâ€ŒØ´ÙˆØ¯.");
  }
</script>
</body>
</html>
