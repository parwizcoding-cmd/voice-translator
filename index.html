<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <title>Voice Translator</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="theme-color" content="#00E676">
  <link rel="manifest" href="manifest.json">

  <style>
    body{
      margin:0;font-family:"Segoe UI",Tahoma,sans-serif;
      background:linear-gradient(135deg,#0f2027,#203a43,#2c5364);
      color:#fff;min-height:100vh;display:flex;justify-content:center;align-items:center;
      padding:18px;box-sizing:border-box
    }
    .card{background:#121212;border-radius:20px;padding:22px;width:100%;max-width:480px;
      box-shadow:0 20px 40px rgba(0,0,0,.5);text-align:center}
    h1{margin:0 0 6px 0;color:#00E676;font-size:26px}
    .pill{display:inline-block;padding:6px 10px;border-radius:999px;background:rgba(0,230,118,.12);
      border:1px solid rgba(0,230,118,.35);color:#b9ffd8;font-size:12px;margin:8px 0 12px 0}
    select,button,textarea{width:100%;padding:12px;margin-top:10px;border-radius:12px;border:none;font-size:16px;box-sizing:border-box}
    select,textarea{background:#1e1e1e;color:#fff}
    textarea{resize:vertical;min-height:78px;direction:rtl}
    .row{display:grid;grid-template-columns:1fr 1fr;gap:10px;margin-top:10px}
    button{background:#00E676;color:#000;font-weight:700;cursor:pointer;transition:transform .15s ease}
    button.secondary{background:#2a2a2a;color:#fff;border:1px solid rgba(255,255,255,.12)}
    button:disabled{opacity:.55;cursor:not-allowed}
    button:active{transform:scale(.97)}
    .box{background:#1e1e1e;border-radius:12px;padding:12px;margin-top:12px;min-height:60px;direction:rtl;text-align:center;word-break:break-word}
    .hint{margin-top:10px;font-size:12px;opacity:.9;line-height:1.7;text-align:center}
    .mini{font-size:12px;opacity:.85;margin-top:8px}
    footer{margin-top:14px;font-size:12px;opacity:.7}
    .iosBox{
      margin-top:10px;padding:10px;border-radius:12px;
      background:rgba(255,255,255,.06);
      border:1px solid rgba(255,255,255,.10);
      display:none
    }
    .iosBox b{color:#00E676}
  </style>
</head>
<body>

<div class="card">
  <h1>ğŸ¤ Ù…ØªØ±Ø¬Ù… ØµÙˆØªÛŒ</h1>
  <div class="pill" id="platformPill">Ø¯Ø±Ø­Ø§Ù„ Ø¨Ø±Ø±Ø³ÛŒ Ø¯Ø³ØªÚ¯Ø§Ù‡â€¦</div>

  <select id="sourceLang" aria-label="Ø²Ø¨Ø§Ù† ÙˆØ±ÙˆØ¯ÛŒ">
    <option value="fa-IR">ÙØ§Ø±Ø³ÛŒ</option>
    <option value="en-US">English</option>
    <option value="fr-FR">FranÃ§ais</option>
    <option value="de-DE">Deutsch</option>
    <option value="tr-TR">TÃ¼rkÃ§e</option>
    <option value="ar-SA">Ø§Ù„Ø¹Ø±Ø¨ÙŠØ©</option>
  </select>

  <select id="targetLang" aria-label="Ø²Ø¨Ø§Ù† Ù…Ù‚ØµØ¯">
    <option value="en">English</option>
    <option value="fa">ÙØ§Ø±Ø³ÛŒ</option>
    <option value="fr">FranÃ§ais</option>
    <option value="de">Deutsch</option>
    <option value="tr">TÃ¼rkÃ§e</option>
    <option value="ar">Ø§Ù„Ø¹Ø±Ø¨ÙŠØ©</option>
  </select>

  <!-- iPhone helper box -->
  <div class="iosBox" id="iosHelp">
    <div class="mini">
      <b>Ø±Ø§Ù‡Ù†Ù…Ø§ÛŒ iPhone:</b><br>
      ØªØ´Ø®ÛŒØµ Ú¯ÙØªØ§Ø± ÙØ§Ø±Ø³ÛŒ Ø¯Ø± Ù…Ø±ÙˆØ±Ú¯Ø± iPhone Ù…Ù…Ú©Ù† Ø§Ø³Øª Ú©Ø§Ø± Ù†Ú©Ù†Ø¯. Ø¨Ø±Ø§ÛŒ ÙØ§Ø±Ø³ÛŒ:
      Ø±ÙˆÛŒ Ú©Ø§Ø¯Ø± Ù…ØªÙ† Ú©Ù„ÛŒÚ© Ú©Ù†ØŒ Ú©ÛŒØ¨ÙˆØ±Ø¯ Ø¨Ø§Ø² Ù…ÛŒâ€ŒØ´ÙˆØ¯ØŒ Ø³Ù¾Ø³ Ø¯Ú©Ù…Ù‡ <b>ğŸ™ï¸ Ù…ÛŒÚ©Ø±ÙˆÙÙˆÙ† (Dictation)</b> Ø±Ø§ Ø¨Ø²Ù† Ùˆ ÙØ§Ø±Ø³ÛŒ ØµØ­Ø¨Øª Ú©Ù†.
      Ø¨Ø¹Ø¯ Ø±ÙˆÛŒ <b>Â«ØªØ±Ø¬Ù…Ù‡ Ù…ØªÙ†Â»</b> Ø¨Ø²Ù†. Ø¨Ø±Ø§ÛŒ ØµØ¯Ø§ Ù‡Ù… Ø­ØªÙ…Ø§Ù‹ <b>Â«Ù¾Ø®Ø´ ØªØ±Ø¬Ù…Ù‡Â»</b> Ø±Ø§ Ø¨Ø²Ù†.
    </div>
  </div>

  <textarea id="manualInput" placeholder="Ø§ÛŒÙ†Ø¬Ø§ Ø¨Ù†ÙˆÛŒØ³â€¦ (Ø¯Ø± iPhone Ù…ÛŒâ€ŒØªÙˆØ§Ù†ÛŒ Ø§Ø² Ø¯ÛŒÚ©ØªÙ‡ Ú©ÛŒØ¨ÙˆØ±Ø¯ Ø§Ø³ØªÙØ§Ø¯Ù‡ Ú©Ù†ÛŒ)"></textarea>

  <!-- Voice picker to improve pronunciation (especially on iPhone) -->
  <select id="voiceSelect" aria-label="Ø§Ù†ØªØ®Ø§Ø¨ ØµØ¯Ø§">
    <option value="">ğŸ”Š Ø§Ù†ØªØ®Ø§Ø¨ ØµØ¯Ø§ÛŒ Ø¨Ù‡ØªØ± (Ø§Ø®ØªÛŒØ§Ø±ÛŒ)</option>
  </select>
  <div class="mini" id="voiceTip"></div>

  <div class="row">
    <button id="recordBtn">ğŸ™ Ø´Ø±ÙˆØ¹ ØµØ­Ø¨Øª</button>
    <button id="translateBtn" class="secondary">ğŸ” ØªØ±Ø¬Ù…Ù‡ Ù…ØªÙ†</button>
  </div>

  <div class="row">
    <button id="playBtn" class="secondary" disabled>ğŸ”Š Ù¾Ø®Ø´ ØªØ±Ø¬Ù…Ù‡</button>
    <button id="stopBtn" class="secondary" disabled>â¹ ØªÙˆÙ‚Ù ØµØ¯Ø§</button>
  </div>

  <div class="box" id="originalText">Ù…ØªÙ† ÙˆØ±ÙˆØ¯ÛŒâ€¦</div>
  <div class="box" id="translatedText">ØªØ±Ø¬Ù…Ù‡â€¦</div>

  <div class="hint" id="hintText"></div>
  <footer>Voice Translator PWA</footer>
</div>

<script>
  // --- Detect iOS ---
  const isIOS = (() => {
    const ua = navigator.userAgent || "";
    const iOS = /iPad|iPhone|iPod/.test(ua);
    const iPadOS = (ua.includes("Mac") && "ontouchend" in document);
    return iOS || iPadOS;
  })();

  const elSource = document.getElementById("sourceLang");
  const elTarget = document.getElementById("targetLang");
  const elRecordBtn = document.getElementById("recordBtn");
  const elTranslateBtn = document.getElementById("translateBtn");
  const elPlayBtn = document.getElementById("playBtn");
  const elStopBtn = document.getElementById("stopBtn");
  const elOriginal = document.getElementById("originalText");
  const elTranslated = document.getElementById("translatedText");
  const elManual = document.getElementById("manualInput");
  const elHint = document.getElementById("hintText");
  const elPill = document.getElementById("platformPill");
  const elIOSHelp = document.getElementById("iosHelp");
  const elVoiceSelect = document.getElementById("voiceSelect");
  const elVoiceTip = document.getElementById("voiceTip");

  elPill.textContent = isIOS ? "ğŸ iPhone/iOS" : "ğŸ¤– Android/Desktop";
  if (isIOS) elIOSHelp.style.display = "block";

  let recognition = null;
  let lastTranslated = "";
  let audioUnlocked = false;

  function showHint(msg){ elHint.textContent = msg || ""; }
  function setAudioButtons(hasText){
    elPlayBtn.disabled = !hasText;
    elStopBtn.disabled = !hasText;
  }

  // Map translate target -> TTS tag
  function getTTSLang(target){
    const map = { fa:"fa-IR", en:"en-US", fr:"fr-FR", de:"de-DE", tr:"tr-TR", ar:"ar-SA" };
    return map[target] || target;
  }

  // --- SpeechRecognition (often missing on iOS Safari) ---
  function initRecognition(){
    const SR = window.SpeechRecognition || window.webkitSpeechRecognition;
    if (!SR) return null;
    const r = new SR();
    r.continuous = false;
    r.interimResults = false;

    r.onresult = async (event) => {
      const text = event.results?.[0]?.[0]?.transcript || "";
      if (!text.trim()) return;

      elOriginal.innerText = text;
      elManual.value = text;

      const target = elTarget.value;
      const translated = await translateText(text, target);

      lastTranslated = translated;
      elTranslated.innerText = translated;
      setAudioButtons(!!translated);

      if (!isIOS) {
        speak(translated, target); // Android ok auto
      } else {
        showHint("Ø¯Ø± iPhone Ø¨Ø±Ø§ÛŒ Ø´Ù†ÛŒØ¯Ù† ØµØ¯Ø§ Ø­ØªÙ…Ø§Ù‹ Â«Ù¾Ø®Ø´ ØªØ±Ø¬Ù…Ù‡Â» Ø±Ø§ Ø¨Ø²Ù†. Ø¨Ø±Ø§ÛŒ ÙØ§Ø±Ø³ÛŒ Ø§Ø² Ø¯ÛŒÚ©ØªÙ‡ Ú©ÛŒØ¨ÙˆØ±Ø¯ Ø§Ø³ØªÙØ§Ø¯Ù‡ Ú©Ù†.");
      }
    };

    r.onerror = () => showHint("ØªØ´Ø®ÛŒØµ ØµØ¯Ø§ Ù…Ø´Ú©Ù„ Ø¯Ø§Ø±Ø¯. Ù…ØªÙ† Ø±Ø§ Ø¯Ø³ØªÛŒ Ø¨Ù†ÙˆÛŒØ³ Ùˆ Â«ØªØ±Ø¬Ù…Ù‡ Ù…ØªÙ†Â» Ø±Ø§ Ø¨Ø²Ù†.");
    return r;
  }
  recognition = initRecognition();

  // --- Unlock audio after user gesture (iOS requirement) ---
  function unlockAudioOnce(){
    if (audioUnlocked) return;
    audioUnlocked = true;
    try{
      speechSynthesis.cancel();
      const u = new SpeechSynthesisUtterance(" ");
      u.volume = 0;
      speechSynthesis.speak(u);
      speechSynthesis.cancel();
    }catch(_){}
  }
  ["click","touchend"].forEach(evt => document.addEventListener(evt, unlockAudioOnce, {once:true}));

  // --- Voice picking (improves pronunciation when voices exist) ---
  function norm(s){ return (s||"").toLowerCase().replace("_","-"); }

  function getVoicesSafe(){
    try { return speechSynthesis.getVoices() || []; } catch(_) { return []; }
  }

  function pickBestVoice(langTag){
    const voices = getVoicesSafe();
    if (!voices.length) return null;
    const want = norm(langTag);
    const base = want.split("-")[0];

    const candidates = voices.filter(v => norm(v.lang) === want)
      .concat(voices.filter(v => norm(v.lang).startsWith(base)));

    // unique by name+lang
    const seen = new Set();
    const uniq = [];
    for (const v of candidates){
      const k = (v.name||"")+"|"+(v.lang||"");
      if (!seen.has(k)){ seen.add(k); uniq.push(v); }
    }
    if (!uniq.length) return null;

    const score = (v) => {
      const name = (v.name||"").toLowerCase();
      let s = 0;
      if (v.default) s += 50;
      if (name.includes("enhanced")) s += 18;
      if (name.includes("premium")) s += 14;
      if (name.includes("google")) s += 12;
      if (name.includes("siri")) s += 10;
      if (name.includes("compact")) s -= 2;
      return s;
    };
    uniq.sort((a,b)=>score(b)-score(a));
    return uniq[0];
  }

  function fillVoiceSelect(){
    const target = elTarget.value;
    const langTag = getTTSLang(target);
    const voices = getVoicesSafe();

    // clear
    elVoiceSelect.innerHTML = `<option value="">ğŸ”Š Ø§Ù†ØªØ®Ø§Ø¨ ØµØ¯Ø§ÛŒ Ø¨Ù‡ØªØ± (Ø§Ø®ØªÛŒØ§Ø±ÛŒ)</option>`;

    // filter voices by base language
    const base = norm(langTag).split("-")[0];
    const list = voices.filter(v => norm(v.lang).startsWith(base));

    if (!list.length){
      elVoiceTip.textContent = isIOS
        ? "Ø§Ú¯Ø± ØªÙ„ÙØ¸ Ø®ÙˆØ¨ Ù†ÛŒØ³ØªØŒ Ù…Ù…Ú©Ù† Ø§Ø³Øª Voice Ø§ÛŒÙ† Ø²Ø¨Ø§Ù† Ø±ÙˆÛŒ iPhone Ù†ØµØ¨ Ù†Ø¨Ø§Ø´Ø¯. Ø¯Ø± Settings â†’ Accessibility â†’ Spoken Content â†’ Voices Ø¢Ù† Ø²Ø¨Ø§Ù† Ø±Ø§ Ø¯Ø§Ù†Ù„ÙˆØ¯ Ú©Ù†."
        : "Voice Ø§ÛŒÙ† Ø²Ø¨Ø§Ù† Ø±ÙˆÛŒ Ø¯Ø³ØªÚ¯Ø§Ù‡ Ù¾ÛŒØ¯Ø§ Ù†Ø´Ø¯.";
      return;
    }

    elVoiceTip.textContent = "Ø¨Ø±Ø§ÛŒ ØªÙ„ÙØ¸ Ø¨Ù‡ØªØ±ØŒ ÛŒÚ© ØµØ¯Ø§ Ø±Ø§ Ø§Ù†ØªØ®Ø§Ø¨ Ú©Ù† (Ø±ÙˆÛŒ iPhone Ø®ÛŒÙ„ÛŒ Ú©Ù…Ú© Ù…ÛŒâ€ŒÚ©Ù†Ø¯).";

    // Add options
    for (const v of list){
      const opt = document.createElement("option");
      opt.value = (v.name||"") + "|" + (v.lang||"");
      opt.textContent = `${v.name} (${v.lang})${v.default ? " â­" : ""}`;
      elVoiceSelect.appendChild(opt);
    }

    // restore saved
    const key = "voice_choice_" + base;
    const saved = localStorage.getItem(key);
    if (saved) elVoiceSelect.value = saved;
  }

  speechSynthesis.getVoices();
  speechSynthesis.onvoiceschanged = () => {
    speechSynthesis.getVoices();
    fillVoiceSelect();
  };

  elTarget.addEventListener("change", () => {
    fillVoiceSelect();
  });

  elVoiceSelect.addEventListener("change", () => {
    const target = elTarget.value;
    const base = norm(getTTSLang(target)).split("-")[0];
    const key = "voice_choice_" + base;
    localStorage.setItem(key, elVoiceSelect.value || "");
  });

  function getChosenVoiceFor(targetLang){
    const langTag = getTTSLang(targetLang);
    const base = norm(langTag).split("-")[0];
    const key = "voice_choice_" + base;
    const saved = localStorage.getItem(key) || "";
    if (!saved) return null;

    const [name, lang] = saved.split("|");
    const voices = getVoicesSafe();
    return voices.find(v => (v.name===name && v.lang===lang)) || null;
  }

  function speak(text, targetLang){
    if (!text) return;
    try { speechSynthesis.cancel(); } catch(_) {}

    const utter = new SpeechSynthesisUtterance(text);
    const ttsLang = getTTSLang(targetLang);
    utter.lang = ttsLang;

    // Use user-selected voice first, else best voice
    const chosen = getChosenVoiceFor(targetLang);
    if (chosen) utter.voice = chosen;
    else {
      const best = pickBestVoice(ttsLang);
      if (best) utter.voice = best;
    }

    // Extra hint for Persian on iOS
    const base = norm(ttsLang).split("-")[0];
    if (isIOS && base === "fa" && !utter.voice){
      showHint("Ø¨Ø±Ø§ÛŒ ØµØ¯Ø§ÛŒ ÙØ§Ø±Ø³ÛŒ Ø¯Ø± iPhone: Settings â†’ Accessibility â†’ Spoken Content â†’ Voices â†’ Persian Ø±Ø§ Ø¯Ø§Ù†Ù„ÙˆØ¯ Ú©Ù†.");
    }

    speechSynthesis.speak(utter);
  }

  // --- Translation ---
  async function translateText(text, target){
    const res = await fetch(
      "https://translate.googleapis.com/translate_a/single?client=gtx&sl=auto&tl=" +
      target + "&dt=t&q=" + encodeURIComponent(text)
    );
    const data = await res.json();
    return (data?.[0]?.[0]?.[0] || "").toString();
  }

  // --- Buttons ---
  elRecordBtn.addEventListener("click", () => {
    unlockAudioOnce();

    if (!recognition){
      // Important iOS message
      if (isIOS){
        showHint("iPhone: Ø¨Ø±Ø§ÛŒ ÙØ§Ø±Ø³ÛŒ Ø±ÙˆÛŒ Ú©Ø§Ø¯Ø± Ù…ØªÙ† Ø¨Ø²Ù† Ùˆ Ø§Ø² Ù…ÛŒÚ©Ø±ÙˆÙÙˆÙ† Ú©ÛŒØ¨ÙˆØ±Ø¯ (Dictation) Ø§Ø³ØªÙØ§Ø¯Ù‡ Ú©Ù†ØŒ Ø³Ù¾Ø³ Â«ØªØ±Ø¬Ù…Ù‡ Ù…ØªÙ†Â».");
      } else {
        showHint("Ù…Ø±ÙˆØ±Ú¯Ø± Ø´Ù…Ø§ ØªØ´Ø®ÛŒØµ ØµØ¯Ø§ Ø±Ø§ Ù¾Ø´ØªÛŒØ¨Ø§Ù†ÛŒ Ù†Ù…ÛŒâ€ŒÚ©Ù†Ø¯. Ù…ØªÙ† Ø±Ø§ Ø¯Ø³ØªÛŒ Ø¨Ù†ÙˆÛŒØ³.");
      }
      return;
    }

    recognition.lang = elSource.value;
    showHint("Ø¯Ø±Ø­Ø§Ù„ Ú¯ÙˆØ´ Ø¯Ø§Ø¯Ù†â€¦");
    try { recognition.start(); } catch(_) {}
  });

  elTranslateBtn.addEventListener("click", async () => {
    unlockAudioOnce();
    const text = (elManual.value || "").trim();
    if (!text){
      showHint("Ø§ÙˆÙ„ Ù…ØªÙ† Ø¨Ù†ÙˆÛŒØ³ (Ø¯Ø± iPhone Ù…ÛŒâ€ŒØªÙˆØ§Ù†ÛŒ Ø¯ÛŒÚ©ØªÙ‡ Ú©Ù†ÛŒ).");
      return;
    }

    elOriginal.innerText = text;

    const target = elTarget.value;
    const translated = await translateText(text, target);

    lastTranslated = translated;
    elTranslated.innerText = translated;
    setAudioButtons(!!translated);

    if (!isIOS) speak(translated, target);
    else showHint("Ø¨Ø±Ø§ÛŒ Ø´Ù†ÛŒØ¯Ù† ØµØ¯Ø§ Ø¯Ø± iPhone Ø±ÙˆÛŒ Â«Ù¾Ø®Ø´ ØªØ±Ø¬Ù…Ù‡Â» Ø¨Ø²Ù†. Ø¨Ø±Ø§ÛŒ ØªÙ„ÙØ¸ Ø¨Ù‡ØªØ±ØŒ ÛŒÚ© Voice Ø§Ù†ØªØ®Ø§Ø¨ Ú©Ù†.");
  });

  elPlayBtn.addEventListener("click", () => {
    unlockAudioOnce();
    if (!lastTranslated) return;
    speak(lastTranslated, elTarget.value);
  });

  elStopBtn.addEventListener("click", () => {
    try { speechSynthesis.cancel(); } catch(_) {}
  });

  // --- Service Worker ---
  if ("serviceWorker" in navigator) {
    navigator.serviceWorker.register("service-worker.js");
  }

  // Init
  setAudioButtons(false);
  fillVoiceSelect();

  if (isIOS){
    showHint("iPhone: Ø¨Ø±Ø§ÛŒ ÙØ§Ø±Ø³ÛŒ Ù…Ø¹Ù…ÙˆÙ„Ø§Ù‹ Ø¨Ø§ÛŒØ¯ Ø§Ø² Ø¯ÛŒÚ©ØªÙ‡ Ú©ÛŒØ¨ÙˆØ±Ø¯ Ø§Ø³ØªÙØ§Ø¯Ù‡ Ú©Ù†ÛŒ. Ø¨Ø±Ø§ÛŒ ØµØ¯Ø§ Â«Ù¾Ø®Ø´ ØªØ±Ø¬Ù…Ù‡Â» Ø±Ø§ Ø¨Ø²Ù† Ùˆ Ø§Ú¯Ø± ØªÙ„ÙØ¸ Ø¨Ø¯ Ø¨ÙˆØ¯ Voice Ø§Ù†ØªØ®Ø§Ø¨ Ú©Ù†.");
  } else {
    showHint("Ø¢Ù…Ø§Ø¯Ù‡ âœ… ØµØ­Ø¨Øª Ú©Ù† ÛŒØ§ Ù…ØªÙ† Ø¨Ù†ÙˆÛŒØ³Ø› ØªØ±Ø¬Ù…Ù‡ Ø§Ù†Ø¬Ø§Ù… Ù…ÛŒâ€ŒØ´ÙˆØ¯.");
  }
</script>
</body>
</html>
