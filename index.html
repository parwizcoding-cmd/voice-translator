<script>
/* ===== Language list ===== */
const LANGS=[
 {n:"ÙØ§Ø±Ø³ÛŒ",sl:"fa-IR",tl:"fa",tts:"fa-IR",rtl:true},
 {n:"English",sl:"en-US",tl:"en",tts:"en-US"},
 {n:"FranÃ§ais",sl:"fr-FR",tl:"fr",tts:"fr-FR"},
 {n:"Deutsch",sl:"de-DE",tl:"de",tts:"de-DE"},
 {n:"Î•Î»Î»Î·Î½Î¹ÎºÎ¬",sl:"el-GR",tl:"el",tts:"el-GR"},
 {n:"Ø§Ù„Ø¹Ø±Ø¨ÙŠØ©",sl:"ar-SA",tl:"ar",tts:"ar-SA",rtl:true},
 {n:"TÃ¼rkÃ§e",sl:"tr-TR",tl:"tr",tts:"tr-TR"},
 {n:"Ð ÑƒÑÑÐºÐ¸Ð¹",sl:"ru-RU",tl:"ru",tts:"ru-RU"}
];

const sLang = document.getElementById("sourceLang");
const tLang = document.getElementById("targetLang");
const original = document.getElementById("original");
const translated = document.getElementById("translated");
const input = document.getElementById("input");
const hint = document.getElementById("hint");
const playBtn = document.getElementById("play");
const recordBtn = document.getElementById("record");
const translateBtn = document.getElementById("translate");
const clearBtn = document.getElementById("clear");

LANGS.forEach(l=>{
  sLang.add(new Option(l.n,l.sl));
  tLang.add(new Option(l.n,l.tl));
});
sLang.value="fa-IR";
tLang.value="en";

let lastTranslated = "";

/* ===== Translate function ===== */
async function translateText(text){
  const url =
    `https://translate.googleapis.com/translate_a/single?client=gtx&sl=auto&tl=${tLang.value}&dt=t&q=${encodeURIComponent(text)}`;

  const res = await fetch(url);
  if(!res.ok) throw new Error("Translate failed");
  const data = await res.json();
  return data?.[0]?.[0]?.[0] || "";
}

/* ===== Speak ===== */
function speak(text){
  if(!text) return;
  speechSynthesis.cancel();

  const langObj = LANGS.find(l=>l.tl===tLang.value);
  const u = new SpeechSynthesisUtterance(text);
  u.lang = langObj?.tts || tLang.value;
  speechSynthesis.speak(u);
}

/* ===== Speech Recognition ===== */
const SR = window.SpeechRecognition || window.webkitSpeechRecognition;
let recognition = null;

if(SR){
  recognition = new SR();
  recognition.continuous = false;
  recognition.interimResults = false;

  recognition.onresult = async (e)=>{
    const text = e.results[0][0].transcript;

    // âœ… Ù†Ù…Ø§ÛŒØ´ Ù…ØªÙ† ØªØ´Ø®ÛŒØµ Ø¯Ø§Ø¯Ù‡ Ø´Ø¯Ù‡
    input.value = text;
    original.textContent = text;
    hint.textContent = "Ø¯Ø± Ø­Ø§Ù„ ØªØ±Ø¬Ù…Ù‡â€¦";

    try{
      const out = await translateText(text);
      translated.textContent = out;
      lastTranslated = out;
      playBtn.disabled = false;

      // Android / Desktop auto speak
      if(!/iPhone|iPad|iPod/.test(navigator.userAgent)){
        speak(out);
      }else{
        hint.textContent = "ØªØ±Ø¬Ù…Ù‡ Ø´Ø¯ âœ“ Ø¨Ø±Ø§ÛŒ ØµØ¯Ø§ Ø±ÙˆÛŒ Ù¾Ø®Ø´ Ø¨Ø²Ù†";
      }
    }catch(err){
      hint.textContent = "âŒ Ø®Ø·Ø§ Ø¯Ø± ØªØ±Ø¬Ù…Ù‡";
      console.error(err);
    }
  };

  recognition.onerror = ()=>{
    hint.textContent = "âŒ ØªØ´Ø®ÛŒØµ ØµØ¯Ø§ Ù†Ø§Ù…ÙˆÙÙ‚ Ø¨ÙˆØ¯";
  };
}

/* ===== Buttons ===== */
recordBtn.onclick = ()=>{
  if(!recognition){
    hint.textContent = "ØªØ´Ø®ÛŒØµ ØµØ¯Ø§ Ù¾Ø´ØªÛŒØ¨Ø§Ù†ÛŒ Ù†Ù…ÛŒâ€ŒØ´ÙˆØ¯";
    return;
  }
  hint.textContent = "ðŸŽ™ Ø¯Ø± Ø­Ø§Ù„ Ú¯ÙˆØ´ Ø¯Ø§Ø¯Ù†â€¦";
  recognition.lang = sLang.value;
  recognition.start();
};

translateBtn.onclick = async ()=>{
  const text = input.value.trim();
  if(!text){
    hint.textContent="Ù…ØªÙ† ÙˆØ§Ø±Ø¯ Ú©Ù†";
    return;
  }
  original.textContent = text;
  hint.textContent = "Ø¯Ø± Ø­Ø§Ù„ ØªØ±Ø¬Ù…Ù‡â€¦";

  try{
    const out = await translateText(text);
    translated.textContent = out;
    lastTranslated = out;
    playBtn.disabled = false;
    hint.textContent = "";
  }catch(e){
    hint.textContent = "âŒ Ø®Ø·Ø§ Ø¯Ø± ØªØ±Ø¬Ù…Ù‡";
  }
};

playBtn.onclick = ()=> speak(lastTranslated);

clearBtn.onclick = ()=>{
  speechSynthesis.cancel();
  input.value="";
  original.textContent="Ù…ØªÙ† ÙˆØ±ÙˆØ¯ÛŒâ€¦";
  translated.textContent="ØªØ±Ø¬Ù…Ù‡â€¦";
  lastTranslated="";
  playBtn.disabled=true;
  hint.textContent="";
};

if("serviceWorker" in navigator){
  navigator.serviceWorker.register("service-worker.js");
}
</script>
