<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <title>Voice Translator</title>

  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="theme-color" content="#00E676">

  <link rel="manifest" href="manifest.json">

  <style>
    body {
      margin: 0;
      font-family: "Segoe UI", Tahoma, sans-serif;
      background: linear-gradient(135deg, #0f2027, #203a43, #2c5364);
      color: #fff;
      min-height: 100vh;
      display: flex;
      justify-content: center;
      align-items: center;
    }

    .card {
      background: #121212;
      border-radius: 20px;
      padding: 25px;
      width: 100%;
      max-width: 440px;
      box-shadow: 0 20px 40px rgba(0,0,0,.5);
      text-align: center;
    }

    h1 {
      margin-top: 0;
      color: #00E676;
      font-size: 26px;
    }

    select, button, textarea {
      width: 100%;
      padding: 12px;
      margin-top: 10px;
      border-radius: 12px;
      border: none;
      font-size: 16px;
      box-sizing: border-box;
    }

    select, textarea {
      background: #1e1e1e;
      color: #fff;
    }

    textarea {
      resize: vertical;
      min-height: 70px;
      direction: rtl;
    }

    .row {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 10px;
      margin-top: 10px;
    }

    button {
      background: #00E676;
      color: #000;
      font-weight: bold;
      cursor: pointer;
      transition: transform .15s ease;
    }

    button.secondary {
      background: #2a2a2a;
      color: #fff;
      border: 1px solid rgba(255,255,255,0.12);
    }

    button:disabled {
      opacity: 0.55;
      cursor: not-allowed;
    }

    button:active {
      transform: scale(0.97);
    }

    .box {
      background: #1e1e1e;
      border-radius: 12px;
      padding: 12px;
      margin-top: 12px;
      min-height: 60px;
      direction: rtl;
      text-align: center;
      word-break: break-word;
    }

    .hint {
      margin-top: 10px;
      font-size: 12px;
      opacity: .8;
      line-height: 1.5;
    }

    .pill {
      display: inline-block;
      padding: 6px 10px;
      border-radius: 999px;
      background: rgba(0,230,118,0.12);
      border: 1px solid rgba(0,230,118,0.35);
      color: #b9ffd8;
      font-size: 12px;
      margin-top: 6px;
    }

    footer {
      margin-top: 15px;
      font-size: 12px;
      opacity: .7;
    }
  </style>
</head>
<body>

  <div class="card">
    <h1>ğŸ¤ Ù…ØªØ±Ø¬Ù… ØµÙˆØªÛŒ</h1>
    <div class="pill" id="platformPill">Ø¯Ø±Ø­Ø§Ù„ Ø¨Ø±Ø±Ø³ÛŒ Ø¯Ø³ØªÚ¯Ø§Ù‡â€¦</div>

    <select id="sourceLang">
      <option value="fa-IR">ÙØ§Ø±Ø³ÛŒ</option>
      <option value="en-US">English</option>
      <option value="de-DE">Deutsch</option>
      <option value="tr-TR">TÃ¼rkÃ§e</option>
      <option value="ar-SA">Ø§Ù„Ø¹Ø±Ø¨ÙŠØ©</option>
    </select>

    <select id="targetLang">
      <option value="en">English</option>
      <option value="fa">ÙØ§Ø±Ø³ÛŒ</option>
      <option value="de">Deutsch</option>
      <option value="tr">TÃ¼rkÃ§e</option>
      <option value="ar">Ø§Ù„Ø¹Ø±Ø¨ÙŠØ©</option>
    </select>

    <!-- Fallback text input (helps iPhone a lot) -->
    <textarea id="manualInput" placeholder="Ø§Ú¯Ø± ØµØ¯Ø§ Ú©Ø§Ø± Ù†Ú©Ø±Ø¯ØŒ Ù…ØªÙ† Ø±Ø§ Ø§ÛŒÙ†Ø¬Ø§ Ø¨Ù†ÙˆÛŒØ³â€¦"></textarea>

    <div class="row">
      <button id="recordBtn">ğŸ™ Ø´Ø±ÙˆØ¹ ØµØ­Ø¨Øª</button>
      <button id="translateBtn" class="secondary">ğŸ” ØªØ±Ø¬Ù…Ù‡ Ù…ØªÙ†</button>
    </div>

    <div class="row">
      <button id="playBtn" class="secondary" disabled>ğŸ”Š Ù¾Ø®Ø´ ØªØ±Ø¬Ù…Ù‡</button>
      <button id="stopBtn" class="secondary" disabled>â¹ ØªÙˆÙ‚Ù ØµØ¯Ø§</button>
    </div>

    <div class="box" id="originalText">Ù…ØªÙ† ÙˆØ±ÙˆØ¯ÛŒâ€¦</div>
    <div class="box" id="translatedText">ØªØ±Ø¬Ù…Ù‡â€¦</div>

    <div class="hint" id="hintText"></div>
    <footer>Voice Translator PWA</footer>
  </div>

<script>
/**
 * iOS rules:
 * - SpeechSynthesis often requires a user gesture to start audio.
 * - SpeechRecognition is limited / often not available.
 * This code keeps Android working and improves iPhone behavior safely.
 */

const elSource = document.getElementById("sourceLang");
const elTarget = document.getElementById("targetLang");
const elRecordBtn = document.getElementById("recordBtn");
const elTranslateBtn = document.getElementById("translateBtn");
const elPlayBtn = document.getElementById("playBtn");
const elStopBtn = document.getElementById("stopBtn");
const elOriginal = document.getElementById("originalText");
const elTranslated = document.getElementById("translatedText");
const elManual = document.getElementById("manualInput");
const elHint = document.getElementById("hintText");
const elPill = document.getElementById("platformPill");

let recognition = null;
let lastTranslated = "";
let audioUnlocked = false;

const isIOS = (() => {
  const ua = navigator.userAgent || "";
  const iOS = /iPad|iPhone|iPod/.test(ua);
  const iPadOS = (ua.includes("Mac") && "ontouchend" in document);
  return iOS || iPadOS;
})();

elPill.textContent = isIOS ? "ğŸ iPhone/iOS" : "ğŸ¤– Android/Desktop";

function showHint(msg) {
  elHint.textContent = msg || "";
}

function setButtonsForAudio(hasText) {
  elPlayBtn.disabled = !hasText;
  elStopBtn.disabled = !hasText;
}

function getTTSLang(target) {
  const map = { fa: "fa-IR", en: "en-US", de: "de-DE", tr: "tr-TR", ar: "ar-SA" };
  return map[target] || target;
}

// Try to create SpeechRecognition (Android/Chrome usually)
function initRecognition() {
  const SR = window.SpeechRecognition || window.webkitSpeechRecognition;
  if (!SR) return null;

  const r = new SR();
  r.continuous = false;
  r.interimResults = false;

  r.onresult = async (event) => {
    const text = event.results?.[0]?.[0]?.transcript || "";
    if (!text.trim()) return;

    elOriginal.innerText = text;
    elManual.value = text; // keep same in textarea too

    const target = elTarget.value;
    const translated = await translateText(text, target);

    lastTranslated = translated;
    elTranslated.innerText = translated;
    setButtonsForAudio(!!translated);

    // IMPORTANT: iOS often blocks auto speak.
    // So we do NOT auto-play. User taps "Play" to hear.
    if (!isIOS) {
      // On Android/desktop, auto speak is usually OK and feels better
      speak(translated, target);
    } else {
      showHint("Ø¯Ø± Ø¢ÛŒÙÙˆÙ†ØŒ Ø¨Ø±Ø§ÛŒ Ø´Ù†ÛŒØ¯Ù† ØµØ¯Ø§ Ø­ØªÙ…Ø§Ù‹ Ø±ÙˆÛŒ Â«Ù¾Ø®Ø´ ØªØ±Ø¬Ù…Ù‡Â» Ø¨Ø²Ù†.");
    }
  };

  r.onerror = () => {
    showHint("Ù…Ø´Ú©Ù„ Ø¯Ø± ØªØ´Ø®ÛŒØµ ØµØ¯Ø§. Ù…ÛŒâ€ŒØªÙˆØ§Ù†ÛŒ Ù…ØªÙ† Ø±Ø§ Ø¯Ø³ØªÛŒ Ø¨Ù†ÙˆÛŒØ³ÛŒ Ùˆ Â«ØªØ±Ø¬Ù…Ù‡ Ù…ØªÙ†Â» Ø±Ø§ Ø¨Ø²Ù†ÛŒ.");
  };

  r.onend = () => {};

  return r;
}

recognition = initRecognition();

// Unlock audio on first user gesture (helps iOS a lot)
function unlockAudioOnUserGesture() {
  if (audioUnlocked) return;
  audioUnlocked = true;

  // Some iOS versions need a speak/cancel sequence after a user action
  try {
    speechSynthesis.cancel();
    const u = new SpeechSynthesisUtterance(" ");
    u.volume = 0; // silent
    speechSynthesis.speak(u);
    speechSynthesis.cancel();
  } catch (_) {}

  showHint(isIOS
    ? "ØµØ¯Ø§ ÙØ¹Ø§Ù„ Ø´Ø¯ âœ… Ø­Ø§Ù„Ø§ Ø¨Ø±Ø§ÛŒ Ø´Ù†ÛŒØ¯Ù† ØªØ±Ø¬Ù…Ù‡ Ø±ÙˆÛŒ Â«Ù¾Ø®Ø´ ØªØ±Ø¬Ù…Ù‡Â» Ø¨Ø²Ù†."
    : "Ø¢Ù…Ø§Ø¯Ù‡ Ø§Ø³Øª âœ…");
}

// Any click/tap in the app unlocks audio once
["click", "touchend"].forEach(evt => {
  document.addEventListener(evt, unlockAudioOnUserGesture, { once: true });
});

elRecordBtn.addEventListener("click", () => {
  unlockAudioOnUserGesture();

  if (!recognition) {
    // iOS fallback
    showHint("ØªØ´Ø®ÛŒØµ ØµØ¯Ø§ Ø¯Ø± Ø§ÛŒÙ† Ù…Ø±ÙˆØ±Ú¯Ø±/Ø¢ÛŒÙÙˆÙ† Ù¾Ø´ØªÛŒØ¨Ø§Ù†ÛŒ Ù†Ù…ÛŒâ€ŒØ´ÙˆØ¯. Ù…ØªÙ† Ø±Ø§ Ø¯Ø³ØªÛŒ Ø¨Ù†ÙˆÛŒØ³ Ùˆ Â«ØªØ±Ø¬Ù…Ù‡ Ù…ØªÙ†Â» Ø±Ø§ Ø¨Ø²Ù†.");
    return;
  }

  const src = elSource.value;
  recognition.lang = src;

  showHint("Ø¯Ø±Ø­Ø§Ù„ Ú¯ÙˆØ´ Ø¯Ø§Ø¯Ù†â€¦ Ø§Ú¯Ø± Ú©Ø§Ø± Ù†Ú©Ø±Ø¯ØŒ Ù…ØªÙ† Ø±Ø§ Ø¯Ø³ØªÛŒ Ø¨Ù†ÙˆÛŒØ³.");
  try { recognition.start(); } catch (_) {}
});

elTranslateBtn.addEventListener("click", async () => {
  unlockAudioOnUserGesture();

  const text = (elManual.value || "").trim();
  if (!text) {
    showHint("Ø§ÙˆÙ„ ÛŒÚ© Ù…ØªÙ† Ø¨Ù†ÙˆÛŒØ³ ÛŒØ§ Ø¨Ø§ Ø¯Ú©Ù…Ù‡ Â«Ø´Ø±ÙˆØ¹ ØµØ­Ø¨ØªÂ» ØµØ­Ø¨Øª Ú©Ù†.");
    return;
  }

  elOriginal.innerText = text;

  const target = elTarget.value;
  const translated = await translateText(text, target);

  lastTranslated = translated;
  elTranslated.innerText = translated;
  setButtonsForAudio(!!translated);

  // On iOS: do NOT auto speak, user taps Play
  if (!isIOS) speak(translated, target);
  else showHint("Ø¨Ø±Ø§ÛŒ Ø´Ù†ÛŒØ¯Ù† ØµØ¯Ø§ØŒ Ø±ÙˆÛŒ Â«Ù¾Ø®Ø´ ØªØ±Ø¬Ù…Ù‡Â» Ø¨Ø²Ù†.");
});

elPlayBtn.addEventListener("click", () => {
  unlockAudioOnUserGesture();
  const target = elTarget.value;
  if (lastTranslated) speak(lastTranslated, target);
});

elStopBtn.addEventListener("click", () => {
  try { speechSynthesis.cancel(); } catch (_) {}
});

async function translateText(text, target) {
  const res = await fetch(
    "https://translate.googleapis.com/translate_a/single?client=gtx&sl=auto&tl=" +
      target +
      "&dt=t&q=" +
      encodeURIComponent(text)
  );
  const data = await res.json();
  return (data?.[0]?.[0]?.[0] || "").toString();
}

function speak(text, lang) {
  if (!text) return;

  try { speechSynthesis.cancel(); } catch (_) {}

  const utter = new SpeechSynthesisUtterance(text);
  utter.lang = getTTSLang(lang);

  // iOS voice list sometimes loads late; speaking still works after unlock in many cases
  speechSynthesis.speak(utter);
}

// Service Worker
if ("serviceWorker" in navigator) {
  navigator.serviceWorker.register("service-worker.js");
}

// Initial hints
if (isIOS) {
  showHint("Ù†Ú©ØªÙ‡ Ø¢ÛŒÙÙˆÙ†: ØªØ´Ø®ÛŒØµ ØµØ¯Ø§ (Ø®ØµÙˆØµØ§Ù‹ ÙØ§Ø±Ø³ÛŒ) Ù…Ù…Ú©Ù† Ø§Ø³Øª Ù…Ø­Ø¯ÙˆØ¯ Ø¨Ø§Ø´Ø¯. Ø§Ú¯Ø± ØµØ¯Ø§ Ú©Ø§Ø± Ù†Ú©Ø±Ø¯ØŒ Ù…ØªÙ† Ø±Ø§ Ø¯Ø³ØªÛŒ Ø¨Ù†ÙˆÛŒØ³. Ø¨Ø±Ø§ÛŒ Ø´Ù†ÛŒØ¯Ù† ØªØ±Ø¬Ù…Ù‡ Ø­ØªÙ…Ø§Ù‹ Â«Ù¾Ø®Ø´ ØªØ±Ø¬Ù…Ù‡Â» Ø±Ø§ Ø¨Ø²Ù†.");
} else {
  showHint("Ø¢Ù…Ø§Ø¯Ù‡ âœ… ØµØ­Ø¨Øª Ú©Ù†Ø› ØªØ±Ø¬Ù…Ù‡ Ùˆ ØµØ¯Ø§ Ø§Ù†Ø¬Ø§Ù… Ù…ÛŒâ€ŒØ´ÙˆØ¯.");
}
</script>
</body>
</html>

